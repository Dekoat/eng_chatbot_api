<?php
/**
 * Broad Topic Handler
 * à¸ˆà¸±à¸”à¸à¸²à¸£à¸„à¸³à¸–à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¹† à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” à¹€à¸Šà¹ˆà¸™ "à¸—à¸¸à¸™à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²", "à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡", "à¸à¸¶à¸à¸‡à¸²à¸™"
 * à¸£à¸°à¸šà¸šà¸ˆà¸°à¹à¸ªà¸”à¸‡à¸ à¸²à¸žà¸£à¸§à¸¡à¸«à¸±à¸§à¸‚à¹‰à¸­ + à¸£à¸²à¸¢à¸à¸²à¸£à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¹ƒà¸«à¹‰à¹€à¸¥à¸·à¸­à¸
 *
 * à¸¡à¸µ 2 à¹à¸šà¸š:
 *   1. department â€” à¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¹à¸•à¸à¸•à¹ˆà¸²à¸‡à¸•à¸²à¸¡à¸ªà¸²à¸‚à¸² (à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡, à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£) â†’ à¹à¸ªà¸”à¸‡à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²
 *   2. faq_list â€” à¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸¡à¸µ FAQ à¸«à¸¥à¸²à¸¢à¸‚à¹‰à¸­ (à¸—à¸¸à¸™, à¸à¸¢à¸¨, à¸à¸¶à¸à¸‡à¸²à¸™) â†’ à¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸à¸²à¸£à¸„à¸³à¸–à¸²à¸¡
 *
 * à¸£à¸§à¸¡ GenericQuestionHandler (post-FAQ-search detection) à¹„à¸§à¹‰à¹ƒà¸™à¸™à¸µà¹‰à¸”à¹‰à¸§à¸¢
 */

require_once __DIR__ . '/ChatbotConfig.php';

class BroadTopicHandler {

    /**
     * Topic Definitions â€” à¹€à¸žà¸´à¹ˆà¸¡/à¹à¸à¹‰à¹„à¸‚à¸«à¸±à¸§à¸‚à¹‰à¸­à¹„à¸”à¹‰à¸—à¸µà¹ˆà¸™à¸µà¹ˆ
     * - keywords: à¸„à¸³à¸—à¸µà¹ˆ trigger topic à¸™à¸µà¹‰
     * - title: à¸Šà¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¸œà¸¥
     * - type: 'department' | 'faq_list'
     * - category (optional): à¸à¸£à¸­à¸‡ FAQ à¸•à¸²à¸¡ category
     * - searchTerms: à¸„à¸³à¸„à¹‰à¸™à¸«à¸²à¹ƒà¸™ question/keywords
     * - suggestion: à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆà¹€à¸ˆà¸²à¸°à¸ˆà¸‡à¸à¸§à¹ˆà¸²
     */
    private static $topicDefinitions = [
        // ===== à¸«à¸±à¸§à¸‚à¹‰à¸­à¹à¸šà¸š per-department (à¹à¸ªà¸”à¸‡à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²) =====
        [
            'id' => 'tuition',
            'keywords' => ['à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡', 'à¸„à¹ˆà¸²à¹€à¸¥à¹ˆà¸²à¹€à¸£à¸µà¸¢à¸™'],
            'title' => 'ðŸ’µ à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡ / à¸„à¹ˆà¸²à¹€à¸¥à¹ˆà¸²à¹€à¸£à¸µà¸¢à¸™',
            'type' => 'department',
            'searchTerms' => ['à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡'],
            'suggestion' => '"à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ" à¸«à¸£à¸·à¸­ "à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸¥"',
            'programs' => [
                ['label' => 'ðŸ”Œ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²'],
                ['label' => 'âš™ï¸ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸¥', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸¥'],
                ['label' => 'ðŸ—ï¸ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹‚à¸¢à¸˜à¸²', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹‚à¸¢à¸˜à¸²'],
                ['label' => 'ðŸ­ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸²à¸£', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸²à¸£'],
                ['label' => 'ðŸ’» à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ'],
                ['label' => 'ðŸ’» à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ (à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡)', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡'],
                ['label' => 'ðŸ¤– à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸¡à¸„à¸„à¸²à¸—à¸£à¸­à¸™à¸´à¸à¸ªà¹Œ', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸¡à¸„à¸„à¸²à¸—à¸£à¸­à¸™à¸´à¸à¸ªà¹Œ'],
                ['label' => 'ðŸ“¡ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£à¹à¸¥à¸°à¸£à¸°à¸šà¸šà¸­à¸±à¸ˆà¸‰à¸£à¸´à¸¢à¸°', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£'],
                ['label' => 'ðŸ”§ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¹à¸¥à¸°à¹à¸¡à¹ˆà¸žà¸´à¸¡à¸žà¹Œ', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¹à¸¥à¸°à¹à¸¡à¹ˆà¸žà¸´à¸¡à¸žà¹Œ'],
                ['label' => 'ðŸ’Ž à¸­à¸ª.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸à¸²à¸£à¸œà¸¥à¸´à¸•à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸›à¸£à¸°à¸”à¸±à¸š', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸›à¸£à¸°à¸”à¸±à¸š'],
                ['label' => 'ðŸ­ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸£à¸£à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸£à¸£à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™'],
                ['label' => 'ðŸ­ à¸­à¸ª.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸—à¸„à¹‚à¸™à¹‚à¸¥à¸¢à¸µà¸™à¸§à¸±à¸•à¸à¸£à¸£à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™ (à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡)', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡ à¸­à¸ª.à¸š. à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™'],
                ['label' => 'ðŸ’Ž à¸¨à¸¥.à¸š. à¸­à¸±à¸à¸¡à¸“à¸µà¸£à¸±à¸‡à¸ªà¸£à¸£à¸„à¹Œ', 'query' => 'à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸­à¸±à¸à¸¡à¸“à¸µà¸£à¸±à¸‡à¸ªà¸£à¸£à¸„à¹Œ'],
            ],
        ],
        [
            'id' => 'curriculum',
            'keywords' => ['à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£', 'à¹à¸œà¸™à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™', 'à¹€à¸£à¸µà¸¢à¸™à¸­à¸°à¹„à¸£', 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£'],
            'excludeKeywords' => ['à¸à¸´à¸ˆà¸à¸£à¸£à¸¡', 'à¸™à¸­à¸à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£'],
            'title' => 'ðŸ“š à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£ / à¹à¸œà¸™à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™',
            'type' => 'department',
            'queryPrefix' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£',
            'categories' => ['à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£', 'curriculum', 'program'],
            'searchTerms' => ['à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£', 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£', 'à¹à¸œà¸™à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™', 'à¹€à¸›à¸´à¸”à¸ªà¸­à¸™', 'à¹€à¸£à¸µà¸¢à¸™à¸­à¸°à¹„à¸£', 'à¸›à¸£à¸´à¸à¸à¸²', 'à¸§à¸´à¸Šà¸²'],
            'suggestion' => '"à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ" à¸«à¸£à¸·à¸­ "à¹€à¸£à¸µà¸¢à¸™à¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡ à¸ªà¸²à¸‚à¸²à¹„à¸Ÿà¸Ÿà¹‰à¸²"',
            'programs' => [
                ['label' => 'ðŸ”Œ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²', 'query' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²'],
                ['label' => 'âš™ï¸ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸¥', 'query' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸¥'],
                ['label' => 'ðŸ—ï¸ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹‚à¸¢à¸˜à¸²', 'query' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹‚à¸¢à¸˜à¸²'],
                ['label' => 'ðŸ­ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸²à¸£', 'query' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸²à¸£'],
                ['label' => 'ðŸ’» à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ', 'query' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ'],
                ['label' => 'ðŸ’» à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ (à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡)', 'query' => 'à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡'],
                ['label' => 'ðŸ¤– à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸¡à¸„à¸„à¸²à¸—à¸£à¸­à¸™à¸´à¸à¸ªà¹Œ', 'query' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸¡à¸„à¸„à¸²à¸—à¸£à¸­à¸™à¸´à¸à¸ªà¹Œ'],
                ['label' => 'ðŸ“¡ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£à¸¯', 'query' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£à¹à¸¥à¸°à¸£à¸°à¸šà¸šà¸­à¸±à¸ˆà¸‰à¸£à¸´à¸¢à¸°'],
                ['label' => 'ðŸ”§ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¹à¸¥à¸°à¹à¸¡à¹ˆà¸žà¸´à¸¡à¸žà¹Œ', 'query' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¹à¸¥à¸°à¹à¸¡à¹ˆà¸žà¸´à¸¡à¸žà¹Œ'],
                ['label' => 'ðŸ’Ž à¸­à¸ª.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸à¸²à¸£à¸œà¸¥à¸´à¸•à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸›à¸£à¸°à¸”à¸±à¸š', 'query' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸›à¸£à¸°à¸”à¸±à¸š'],
                ['label' => 'ðŸ­ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸£à¸£à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™', 'query' => 'à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸£à¸£à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™'],
                ['label' => 'ðŸ­ à¸­à¸ª.à¸š. à¹€à¸—à¸„à¹‚à¸™à¹‚à¸¥à¸¢à¸µà¸™à¸§à¸±à¸•à¸à¸£à¸£à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™ (à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡)', 'query' => 'à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£ à¸­à¸ª.à¸š. à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™'],
                ['label' => 'ðŸ’Ž à¸¨à¸¥.à¸š. à¸­à¸±à¸à¸¡à¸“à¸µà¸£à¸±à¸‡à¸ªà¸£à¸£à¸„à¹Œ', 'query' => 'à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸­à¸±à¸à¸¡à¸“à¸µà¸£à¸±à¸‡à¸ªà¸£à¸£à¸„à¹Œ'],
            ],
        ],
        [
            'id' => 'career',
            'keywords' => ['à¸­à¸²à¸Šà¸µà¸ž', 'à¸ˆà¸šà¹à¸¥à¹‰à¸§à¸—à¸³à¸­à¸°à¹„à¸£', 'à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£'],
            'title' => 'ðŸ’¼ à¹‚à¸­à¸à¸²à¸ªà¸—à¸³à¸‡à¸²à¸™ / à¸­à¸²à¸Šà¸µà¸ž',
            'type' => 'department',
            'searchTerms' => ['à¸­à¸²à¸Šà¸µà¸ž', 'à¸—à¸³à¸‡à¸²à¸™', 'à¸ˆà¸šà¹à¸¥à¹‰à¸§'],
            'suggestion' => '"à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£" à¸«à¸£à¸·à¸­ "à¸­à¸²à¸Šà¸µà¸žà¸ªà¸²à¸‚à¸²à¹„à¸Ÿà¸Ÿà¹‰à¸²"',
            'programs' => [
                ['label' => 'ðŸ”Œ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸² à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'âš™ï¸ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸¥', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸¥ à¸›à¸£à¸°à¸à¸­à¸šà¸­à¸²à¸Šà¸µà¸žà¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ—ï¸ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹‚à¸¢à¸˜à¸²', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹‚à¸¢à¸˜à¸² à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ­ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸²à¸£', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸²à¸£ à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ’» à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ’» à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ (à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡)', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡ à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ¤– à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸¡à¸„à¸„à¸²à¸—à¸£à¸­à¸™à¸´à¸à¸ªà¹Œ', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸¡à¸„à¸„à¸²à¸—à¸£à¸­à¸™à¸´à¸à¸ªà¹Œ à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ“¡ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£à¸¯', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹„à¸Ÿà¸Ÿà¹‰à¸²à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£ à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ”§ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¹à¸¥à¸°à¹à¸¡à¹ˆà¸žà¸´à¸¡à¸žà¹Œ', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¹à¸¥à¸°à¹à¸¡à¹ˆà¸žà¸´à¸¡à¸žà¹Œ à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ’Ž à¸­à¸ª.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸à¸²à¸£à¸œà¸¥à¸´à¸•à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸›à¸£à¸°à¸”à¸±à¸š', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸à¸²à¸£à¸œà¸¥à¸´à¸•à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸›à¸£à¸°à¸”à¸±à¸š à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ­ à¸§à¸¨.à¸š. à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸£à¸£à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™', 'query' => 'à¸ˆà¸š SIME à¹à¸¥à¹‰à¸§à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ­ à¸­à¸ª.à¸š. à¹€à¸—à¸„à¹‚à¸™à¹‚à¸¥à¸¢à¸µà¸™à¸§à¸±à¸•à¸à¸£à¸£à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™ (à¸•à¹ˆà¸­à¹€à¸™à¸·à¹ˆà¸­à¸‡)', 'query' => 'à¸ˆà¸š à¸­à¸ª.à¸š. à¸¢à¸±à¹ˆà¸‡à¸¢à¸·à¸™ à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
                ['label' => 'ðŸ’Ž à¸¨à¸¥.à¸š. à¸­à¸±à¸à¸¡à¸“à¸µà¸£à¸±à¸‡à¸ªà¸£à¸£à¸„à¹Œ', 'query' => 'à¸ˆà¸šà¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸à¸²à¸£à¸œà¸¥à¸´à¸•à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸›à¸£à¸°à¸”à¸±à¸š à¸—à¸³à¸‡à¸²à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡'],
            ],
        ],

        // ===== à¸«à¸±à¸§à¸‚à¹‰à¸­à¹à¸šà¸š faq_list (à¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸à¸²à¸£à¸„à¸³à¸–à¸²à¸¡) =====
        [
            'id' => 'scholarship',
            'keywords' => ['à¸—à¸¸à¸™à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²', 'à¸—à¸¸à¸™'],
            'title' => 'ðŸŽ“ à¸—à¸¸à¸™à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²',
            'type' => 'faq_list',
            'category' => 'loan',
            'searchTerms' => ['à¸—à¸¸à¸™à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²'],
            'suggestion' => '"à¸¡à¸µà¸—à¸¸à¸™à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²à¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡" à¸«à¸£à¸·à¸­ "à¸§à¸´à¸˜à¸µà¸ªà¸¡à¸±à¸„à¸£à¸—à¸¸à¸™"',
        ],
        [
            'id' => 'loan',
            'keywords' => ['à¸à¸¢à¸¨', 'à¸à¸¹à¹‰à¸¢à¸·à¸¡', 'à¸à¸­à¸‡à¸—à¸¸à¸™', 'à¸à¸£à¸­'],
            'title' => 'ðŸ’° à¸à¸­à¸‡à¸—à¸¸à¸™à¸à¸¹à¹‰à¸¢à¸·à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸² (à¸à¸¢à¸¨./à¸à¸£à¸­.)',
            'type' => 'faq_list',
            'category' => 'loan',
            'searchTerms' => ['à¸à¸¢à¸¨', 'à¸à¸¹à¹‰à¸¢à¸·à¸¡', 'à¸à¸£à¸­.'],
            'suggestion' => '"à¸„à¸¸à¸“à¸ªà¸¡à¸šà¸±à¸•à¸´à¸à¸¹à¹‰à¸¢à¸·à¸¡ à¸à¸¢à¸¨." à¸«à¸£à¸·à¸­ "à¹€à¸­à¸à¸ªà¸²à¸£à¸à¸¹à¹‰à¸¢à¸·à¸¡"',
        ],
        [
            'id' => 'internship',
            'keywords' => ['à¸à¸¶à¸à¸‡à¸²à¸™'],
            'title' => 'ðŸ¢ à¸à¸¶à¸à¸‡à¸²à¸™ / à¸ªà¸«à¸à¸´à¸ˆà¸¨à¸¶à¸à¸©à¸²',
            'type' => 'faq_list',
            'searchTerms' => ['à¸à¸¶à¸à¸‡à¸²à¸™', 'à¸ªà¸«à¸à¸´à¸ˆ'],
            'suggestion' => '"à¸à¸¶à¸à¸‡à¸²à¸™à¸›à¸µà¹„à¸«à¸™" à¸«à¸£à¸·à¸­ "à¸à¸¶à¸à¸‡à¸²à¸™à¸ªà¸²à¸‚à¸²à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸¥"',
        ],
        [
            'id' => 'coop',
            'keywords' => ['à¸ªà¸«à¸à¸´à¸ˆ', 'à¸ªà¸«à¸à¸´à¸ˆà¸¨à¸¶à¸à¸©à¸²'],
            'title' => 'ðŸ¤ à¸ªà¸«à¸à¸´à¸ˆà¸¨à¸¶à¸à¸©à¸²',
            'type' => 'faq_list',
            'searchTerms' => ['à¸ªà¸«à¸à¸´à¸ˆ'],
            'suggestion' => '"à¸ªà¸«à¸à¸´à¸ˆà¸¨à¸¶à¸à¸©à¸² à¹€à¸£à¸µà¸¢à¸™à¸›à¸µà¹„à¸«à¸™" à¸«à¸£à¸·à¸­ "à¸ªà¸«à¸à¸´à¸ˆ à¸ªà¸²à¸‚à¸²à¸­à¸¸à¸•à¸ªà¸²à¸«à¸à¸²à¸£"',
        ],
        [
            'id' => 'transfer',
            'keywords' => ['à¹‚à¸­à¸™à¸«à¸™à¹ˆà¸§à¸¢à¸à¸´à¸•', 'à¹€à¸—à¸µà¸¢à¸šà¹‚à¸­à¸™'],
            'title' => 'ðŸ”„ à¹‚à¸­à¸™à¸«à¸™à¹ˆà¸§à¸¢à¸à¸´à¸• / à¹€à¸—à¸µà¸¢à¸šà¹‚à¸­à¸™',
            'type' => 'faq_list',
            'searchTerms' => ['à¹‚à¸­à¸™à¸«à¸™à¹ˆà¸§à¸¢à¸à¸´à¸•', 'à¹€à¸—à¸µà¸¢à¸šà¹‚à¸­à¸™'],
            'suggestion' => '"à¹€à¸—à¸µà¸¢à¸šà¹‚à¸­à¸™ à¸›à¸§à¸ª." à¸«à¸£à¸·à¸­ "à¹‚à¸­à¸™à¸«à¸™à¹ˆà¸§à¸¢à¸à¸´à¸• à¸ªà¸²à¸‚à¸²à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸¥"',
        ],
        [
            'id' => 'admission',
            'keywords' => ['à¸ªà¸¡à¸±à¸„à¸£à¹€à¸£à¸µà¸¢à¸™', 'à¸£à¸±à¸šà¸ªà¸¡à¸±à¸„à¸£'],
            'title' => 'ðŸ“ à¸à¸²à¸£à¸£à¸±à¸šà¸ªà¸¡à¸±à¸„à¸£à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²',
            'type' => 'faq_list',
            'category' => 'admission',
            'searchTerms' => ['à¸£à¸±à¸šà¸ªà¸¡à¸±à¸„à¸£', 'à¸ªà¸¡à¸±à¸„à¸£à¹€à¸£à¸µà¸¢à¸™', 'à¸ªà¸¡à¸±à¸„à¸£à¹€à¸‚à¹‰à¸²', 'à¸œà¸¹à¹‰à¸ªà¸¡à¸±à¸„à¸£'],
            'suggestion' => '"à¸„à¸¸à¸“à¸ªà¸¡à¸šà¸±à¸•à¸´à¸ªà¸¡à¸±à¸„à¸£à¹€à¸£à¸µà¸¢à¸™" à¸«à¸£à¸·à¸­ "à¸ªà¸¡à¸±à¸„à¸£à¹€à¸£à¸µà¸¢à¸™à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ"',
        ],
        [
            'id' => 'grade',
            'keywords' => ['à¹€à¸à¸£à¸”', 'à¸œà¸¥à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™', 'à¹€à¸à¸£à¸” F', 'à¸•à¸´à¸”à¹€à¸à¸£à¸”', 'à¸•à¸´à¸” F'],
            'title' => 'ðŸ“Š à¹€à¸à¸£à¸” / à¸œà¸¥à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™',
            'type' => 'faq_list',
            'searchTerms' => ['à¹€à¸à¸£à¸”', 'GPA', 'à¸œà¸¥à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™', 'à¹€à¸à¸£à¸” F', 'à¸•à¸´à¸” F'],
            'suggestion' => '"à¹€à¸à¸£à¸”à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸‚à¸±à¹‰à¸™à¸•à¹ˆà¸³" à¸«à¸£à¸·à¸­ "à¸•à¸´à¸” F à¸—à¸³à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£"',
        ],

        // ===== à¸«à¸±à¸§à¸‚à¹‰à¸­à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ =====
        [
            'id' => 'programs',
            'keywords' => ['à¸ªà¸²à¸‚à¸²', 'à¸¡à¸µà¸ªà¸²à¸‚à¸²', 'à¹€à¸›à¸´à¸”à¸ªà¸­à¸™', 'à¸„à¸“à¸°à¸§à¸´à¸¨à¸§à¸°'],
            'title' => 'ðŸ›ï¸ à¸ªà¸²à¸‚à¸²à¸§à¸´à¸Šà¸² / à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸—à¸µà¹ˆà¹€à¸›à¸´à¸”à¸ªà¸­à¸™',
            'type' => 'faq_list',
            'searchTerms' => ['à¸ªà¸²à¸‚à¸²', 'à¹€à¸›à¸´à¸”à¸ªà¸­à¸™', 'à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£'],
            'suggestion' => '"à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ" à¸«à¸£à¸·à¸­ "à¸ªà¸²à¸‚à¸²à¹„à¸Ÿà¸Ÿà¹‰à¸²"',
        ],
        [
            'id' => 'registration',
            'keywords' => ['à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™', 'à¸¥à¸‡à¹€à¸£à¸µà¸¢à¸™'],
            'title' => 'ðŸ“ à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹€à¸£à¸µà¸¢à¸™',
            'type' => 'faq_list',
            'searchTerms' => ['à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™', 'à¸¥à¸‡à¹€à¸£à¸µà¸¢à¸™', 'à¹€à¸žà¸´à¹ˆà¸¡à¸–à¸­à¸™'],
            'suggestion' => '"à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™" à¸«à¸£à¸·à¸­ "à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸­à¸­à¸™à¹„à¸¥à¸™à¹Œ"',
        ],
        [
            'id' => 'retire',
            'keywords' => ['à¸žà¹‰à¸™à¸ªà¸ à¸²à¸ž', 'à¸£à¸µà¹„à¸—à¸£à¹Œ'],
            'title' => 'âš ï¸ à¸à¸²à¸£à¸žà¹‰à¸™à¸ªà¸ à¸²à¸žà¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²',
            'type' => 'faq_list',
            'searchTerms' => ['à¸žà¹‰à¸™à¸ªà¸ à¸²à¸ž', 'à¸£à¸µà¹„à¸—à¸£à¹Œ', 'retire'],
            'suggestion' => '"à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸žà¹‰à¸™à¸ªà¸ à¸²à¸ž" à¸«à¸£à¸·à¸­ "GPA à¸•à¹ˆà¸³à¸ªà¸¸à¸”à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ"',
        ],
        [
            'id' => 'contact',
            'keywords' => ['à¸•à¸´à¸”à¸•à¹ˆà¸­', 'à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£', 'à¸­à¸µà¹€à¸¡à¸¥'],
            'title' => 'ðŸ“ž à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸•à¸´à¸”à¸•à¹ˆà¸­',
            'type' => 'faq_list',
            'searchTerms' => ['à¸•à¸´à¸”à¸•à¹ˆà¸­', 'à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£', 'à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ', 'à¸­à¸µà¹€à¸¡à¸¥', 'à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ'],
            'suggestion' => '"à¸•à¸´à¸”à¸•à¹ˆà¸­à¸ªà¸²à¸‚à¸²à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ" à¸«à¸£à¸·à¸­ "à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸„à¸“à¸°"',
        ],
        [
            'id' => 'duration',
            'keywords' => ['à¹€à¸£à¸µà¸¢à¸™à¸à¸µà¹ˆà¸›à¸µ', 'à¸à¸µà¹ˆà¸›à¸µ'],
            'title' => 'ðŸ“… à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²à¹€à¸£à¸µà¸¢à¸™',
            'type' => 'department',
            'searchTerms' => ['à¸à¸µà¹ˆà¸›à¸µ', 'à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²', 'à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£'],
            'suggestion' => '"à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¹€à¸£à¸µà¸¢à¸™à¸à¸µà¹ˆà¸›à¸µ" à¸«à¸£à¸·à¸­ "à¸›à¸£à¸´à¸à¸à¸²à¸•à¸£à¸µà¸à¸µà¹ˆà¸›à¸µ"',
        ],
    ];

    /**
     * Department label mapping â€” à¹ƒà¸Šà¹‰à¸ˆà¸²à¸ ChatbotConfig
     */
    private static function getDeptLabel($dept) {
        return ChatbotConfig::$departmentDisplayLabels[$dept] ?? null;
    }

    /**
     * à¸•à¸±à¸”à¸„à¸³à¸™à¸³à¸«à¸™à¹‰à¸²à¹à¸¥à¸°à¸„à¸³à¸•à¹ˆà¸­à¸—à¹‰à¸²à¸¢à¸—à¸±à¹ˆà¸§à¹„à¸›à¸­à¸­à¸à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
     * à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¹€à¸«à¸¥à¸·à¸­à¹à¸„à¹ˆ keyword à¸«à¸¥à¸±à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¸ˆà¸±à¸šà¸„à¸¹à¹ˆ topic
     */
    private static function cleanMessage($message) {
        // à¸•à¸±à¸”à¸„à¸³à¸™à¸³à¸«à¸™à¹‰à¸²
        $prefixes = [
            'à¸­à¸¢à¸²à¸à¸£à¸¹à¹‰à¹€à¸£à¸·à¹ˆà¸­à¸‡', 'à¸­à¸¢à¸²à¸à¸–à¸²à¸¡à¹€à¸£à¸·à¹ˆà¸­à¸‡', 'à¸–à¸²à¸¡à¹€à¸£à¸·à¹ˆà¸­à¸‡',
            'à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸š', 'à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸š', 'à¹€à¸£à¸·à¹ˆà¸­à¸‡',
            'à¸–à¸²à¸¡à¸§à¹ˆà¸²', 'à¸–à¸²à¸¡', 'à¸ªà¸­à¸šà¸–à¸²à¸¡', 'à¸‚à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥', 'à¸‚à¸­à¸–à¸²à¸¡',
            'à¸­à¸¢à¸²à¸à¸£à¸¹à¹‰', 'à¸­à¸¢à¸²à¸à¸—à¸£à¸²à¸š', 'à¸­à¸¢à¸²à¸à¸”à¸¹', 'à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥',
            'à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”', 'à¸‚à¸­à¸”à¸¹', 'à¸”à¸¹',
        ];
        $message = trim($message);
        foreach ($prefixes as $prefix) {
            if (mb_strpos($message, $prefix) === 0) {
                $message = trim(mb_substr($message, mb_strlen($prefix)));
                break;
            }
        }
        
        // à¸•à¸±à¸”à¸„à¸³à¸•à¹ˆà¸­à¸—à¹‰à¸²à¸¢à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸„à¸³à¸–à¸²à¸¡ (à¸„à¸·à¸­à¸­à¸°à¹„à¸£, à¸—à¸³à¸¢à¸±à¸‡à¹„à¸‡, à¸¯à¸¥à¸¯)
        $suffixes = [
            'à¸„à¸·à¸­à¸­à¸°à¹„à¸£', 'à¸¡à¸µà¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡', 'à¸—à¸³à¸¢à¸±à¸‡à¹„à¸‡à¸”à¸µ', 'à¸—à¸³à¸¢à¸±à¸‡à¹„à¸‡', 'à¸¢à¸±à¸‡à¹„à¸‡à¸”à¸µ', 'à¸¢à¸±à¸‡à¹„à¸‡',
            'à¹„à¸”à¹‰à¸¢à¸±à¸‡à¹„à¸‡', 'à¸—à¸³à¹„à¸‡', 'à¹„à¸”à¹‰à¹„à¸«à¸¡', 'à¹„à¸”à¹‰à¸¡à¸±à¹‰à¸¢', 'à¸•à¹‰à¸­à¸‡à¸—à¸³à¸¢à¸±à¸‡à¹„à¸‡', 'à¸—à¸³à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£',
            'à¸­à¸¢à¹ˆà¸²à¸‡à¹„à¸£', 'à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ', 'à¸—à¸µà¹ˆà¹„à¸«à¸™', 'à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸«à¸£à¹ˆ', 'à¸«à¸£à¸·à¸­à¹€à¸›à¸¥à¹ˆà¸²',
            'à¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡', 'à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡', 'à¸šà¹‰à¸²à¸‡', 'à¹„à¸«à¸¡', 'à¸¡à¸±à¹‰à¸¢',
        ];
        foreach ($suffixes as $suffix) {
            $pos = mb_strrpos($message, $suffix);
            if ($pos !== false && ($pos + mb_strlen($suffix)) === mb_strlen($message)) {
                $message = trim(mb_substr($message, 0, $pos));
                break;
            }
        }
        
        return $message;
    }

    /**
     * à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¸§à¹ˆà¸²à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸„à¸³à¸–à¸²à¸¡à¸à¸§à¹‰à¸²à¸‡à¹† à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸«à¸±à¸§à¸‚à¹‰à¸­à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
     * @return array|null topic config à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ broad topic, null à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ
     */
    public static function detectBroadTopic($message) {
        $message = trim($message);

        // à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¹€à¸à¸´à¸™à¸à¸§à¹ˆà¸² 40 chars â†’ à¸™à¹ˆà¸²à¸ˆà¸°à¹€à¸ˆà¸²à¸°à¸ˆà¸‡à¹à¸¥à¹‰à¸§
        if (mb_strlen($message) > 40) {
            return null;
        }

        // à¸•à¸±à¸”à¸„à¸³à¸™à¸³à¸«à¸™à¹‰à¸² + à¸„à¸³à¸•à¹ˆà¸­à¸—à¹‰à¸²à¸¢à¸­à¸­à¸
        $cleanMsg = self::cleanMessage($message);
        if (mb_strlen($cleanMsg) > 25 || mb_strlen($cleanMsg) < 2) {
            return null;
        }

        // à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸²à¸£à¸°à¸šà¸¸à¸ªà¸²à¸‚à¸²à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡ â€” à¸–à¹‰à¸²à¸£à¸°à¸šà¸¸à¹à¸¥à¹‰à¸§à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ broad
        foreach (ChatbotConfig::$departmentDetectKeywords as $dept) {
            if (mb_stripos($cleanMsg, $dept) !== false) {
                return null;
            }
        }

        // à¸ˆà¸±à¸šà¸„à¸¹à¹ˆ topic â€” keyword à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸ªà¹ˆà¸§à¸™à¹ƒà¸«à¸à¹ˆà¸‚à¸­à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ (â‰¥ 40%)
        // à¸¥à¸”à¸ˆà¸²à¸ 60% â†’ 40% à¹€à¸žà¸·à¹ˆà¸­à¸ˆà¸±à¸šà¸„à¸³à¸–à¸²à¸¡à¹à¸šà¸š "à¸ªà¸«à¸à¸´à¸ˆà¸¨à¸¶à¸à¸©à¸²à¸„à¸·à¸­à¸­à¸°à¹„à¸£" à¹„à¸”à¹‰
        // (à¸«à¸¥à¸±à¸‡à¸•à¸±à¸” suffix à¹à¸¥à¹‰à¸§ ratio à¸ˆà¸°à¸ªà¸¹à¸‡à¸‚à¸¶à¹‰à¸™)
        foreach (self::$topicDefinitions as $topic) {
            foreach ($topic['keywords'] as $kw) {
                if (mb_stripos($cleanMsg, $kw) !== false) {
                    // âœ… à¸•à¸£à¸§à¸ˆ excludeKeywords â€” à¸–à¹‰à¸²à¸¡à¸µà¸„à¸³à¸—à¸µà¹ˆà¸«à¹‰à¸²à¸¡ à¸‚à¹‰à¸²à¸¡ topic à¸™à¸µà¹‰
                    if (!empty($topic['excludeKeywords'])) {
                        $excluded = false;
                        foreach ($topic['excludeKeywords'] as $exKw) {
                            if (mb_stripos($cleanMsg, $exKw) !== false) {
                                error_log("[BroadTopic] Skip topic '{$topic['id']}' â€” excludeKeyword='$exKw' found in '$cleanMsg'");
                                $excluded = true;
                                break;
                            }
                        }
                        if ($excluded) break; // skip this topic, try next
                    }
                    $ratio = mb_strlen($kw) / mb_strlen($cleanMsg);
                    if ($ratio >= 0.4) {
                        error_log("[BroadTopic] Detected topic '{$topic['id']}' â€” keyword='$kw', cleanMsg='$cleanMsg', ratio=" . round($ratio, 2));
                        return $topic;
                    }
                }
            }
        }

        return null;
    }

    /**
     * à¸„à¹‰à¸™à¸«à¸² FAQ à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸š topic
     */
    public static function searchRelatedFAQs($topic, $db) {
        $results = [];
        $existingIds = [];

        // à¸ªà¸³à¸«à¸£à¸±à¸š department type: à¸„à¹‰à¸™à¸«à¸²à¸”à¹‰à¸§à¸¢ searchTerms à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸ (à¸•à¹‰à¸­à¸‡à¸„à¸£à¸­à¸šà¸„à¸¥à¸¸à¸¡à¸—à¸¸à¸à¸ªà¸²à¸‚à¸²)
        // à¸ªà¸³à¸«à¸£à¸±à¸š faq_list type: à¸„à¹‰à¸™à¸«à¸²à¸•à¸²à¸¡ category + searchTerms

        // 1. à¸„à¹‰à¸™à¸«à¸²à¸•à¸²à¸¡ searchTerms (à¸ªà¸³à¸„à¸±à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¸—à¸¸à¸ type)
        if (!empty($topic['searchTerms'])) {
            $conditions = [];
            $params = [];
            foreach ($topic['searchTerms'] as $term) {
                $conditions[] = "question LIKE ?";
                $conditions[] = "keywords LIKE ?";
                $params[] = "%{$term}%";
                $params[] = "%{$term}%";
            }
            $limit = ($topic['type'] === 'department') ? 100 : 30;
            $sql = "SELECT id, question, answer, category, department 
                    FROM faq WHERE is_active = 1 AND (" . implode(' OR ', $conditions) . ") 
                    ORDER BY id ASC LIMIT {$limit}";
            $stmt = $db->prepare($sql);
            $stmt->execute($params);
            $rows = $stmt->fetchAll();
            foreach ($rows as $row) {
                $results[] = $row;
                $existingIds[] = $row['id'];
            }
        }

        // 2. à¹€à¸ªà¸£à¸´à¸¡à¸”à¹‰à¸§à¸¢ category (à¸–à¹‰à¸²à¸¡à¸µ â€” à¹ƒà¸Šà¹‰à¸—à¸±à¹‰à¸‡ faq_list à¹à¸¥à¸° department type)
        $categories = [];
        if (!empty($topic['category'])) {
            $categories = is_array($topic['category']) ? $topic['category'] : [$topic['category']];
        }
        if (!empty($topic['categories'])) {
            $categories = array_merge($categories, $topic['categories']);
        }
        $categories = array_unique($categories);
        
        if (!empty($categories)) {
            $placeholders = implode(',', array_fill(0, count($categories), '?'));
            $catLimit = ($topic['type'] === 'department') ? 500 : 40;
            $stmt = $db->prepare("SELECT id, question, answer, category, department 
                                  FROM faq WHERE is_active = 1 AND category IN ({$placeholders}) 
                                  ORDER BY id ASC LIMIT {$catLimit}");
            $stmt->execute($categories);
            $rows = $stmt->fetchAll();
            foreach ($rows as $row) {
                if (!in_array($row['id'], $existingIds)) {
                    $results[] = $row;
                    $existingIds[] = $row['id'];
                }
            }
        }

        error_log("[BroadTopic] Found " . count($results) . " FAQs for topic '{$topic['id']}'");
        return $results;
    }

    /**
     * à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¸ à¸²à¸žà¸£à¸§à¸¡à¸ªà¸³à¸«à¸£à¸±à¸š broad topic
     */
    public static function buildTopicOverview($topic, $faqs) {
        if ($topic['type'] === 'department') {
            return self::buildDepartmentOverview($topic, $faqs);
        }
        return self::buildFAQListOverview($topic, $faqs);
    }

    /**
     * à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¹à¸šà¸šà¹à¸ªà¸”à¸‡à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²
     */
    private static function buildDepartmentOverview($topic, $faqs) {
        // à¸–à¹‰à¸² topic à¸¡à¸µ programs list â†’ à¹ƒà¸Šà¹‰à¸£à¸²à¸¢à¸à¸²à¸£à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¸•à¸£à¸‡à¹† à¹à¸—à¸™à¸à¸²à¸£ auto-detect à¸ˆà¸²à¸ FAQ
        if (!empty($topic['programs'])) {
            $answer = "{$topic['title']}\n\n";
            $answer .= "à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸™à¸µà¹‰à¹à¸•à¸à¸•à¹ˆà¸²à¸‡à¸à¸±à¸™à¹ƒà¸™à¹à¸•à¹ˆà¸¥à¸°à¸ªà¸²à¸‚à¸² à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆà¸ªà¸™à¹ƒà¸ˆ:\n\n";

            $num = 1;
            foreach ($topic['programs'] as $program) {
                $answer .= "{$num}. [[{$program['query']}||{$program['label']}]]\n";
                $num++;
            }

            $answer .= "\nðŸ’¡ à¸à¸”à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆà¸ªà¸™à¹ƒà¸ˆ à¸«à¸£à¸·à¸­à¸žà¸´à¸¡à¸žà¹Œà¸–à¸²à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢";

            return [
                'answer' => $answer,
                'related_questions' => [],
            ];
        }

        // à¸£à¸§à¸šà¸£à¸§à¸¡à¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆà¸¡à¸µ FAQ â€” à¹ƒà¸Šà¹‰ searchTerms à¸à¸£à¸­à¸‡à¹ƒà¸«à¹‰à¹„à¸”à¹‰à¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸ˆà¸£à¸´à¸‡
        $departments = [];
        $searchTerms = $topic['searchTerms'] ?? [];

        foreach ($faqs as $faq) {
            $dept = $faq['department'] ?? 'general';
            if ($dept === 'general' || $dept === 'student_affairs') continue;
            if (isset($departments[$dept])) continue;

            // à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸² FAQ à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸š topic (à¸¡à¸µ searchTerm à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ question)
            if (!empty($searchTerms)) {
                $question = explode('|', $faq['question'])[0];
                $isRelevant = false;
                foreach ($searchTerms as $term) {
                    if (mb_stripos($question, $term) !== false) {
                        $isRelevant = true;
                        break;
                    }
                }
                if (!$isRelevant) continue;
            }

            // à¸à¸£à¸­à¸‡à¹€à¸‰à¸žà¸²à¸°à¸ªà¸²à¸‚à¸²à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸—à¸µà¹ˆà¸£à¸¹à¹‰à¸ˆà¸±à¸à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™
            if (!isset(ChatbotConfig::$departmentDisplayLabels[$dept])) continue;

            $departments[$dept] = ChatbotConfig::$departmentDisplayLabels[$dept];
        }

        if (empty($departments)) {
            return null;
        }

        $answer = "{$topic['title']}\n\n";
        $answer .= "à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸™à¸µà¹‰à¹à¸•à¸à¸•à¹ˆà¸²à¸‡à¸à¸±à¸™à¹ƒà¸™à¹à¸•à¹ˆà¸¥à¸°à¸ªà¸²à¸‚à¸² à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆà¸ªà¸™à¹ƒà¸ˆ:\n\n";

        // à¸ªà¸£à¹‰à¸²à¸‡à¸›à¸¸à¹ˆà¸¡à¸à¸”à¸‹à¸¶à¹ˆà¸‡à¸à¸±à¸‡à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸„à¸³à¸•à¸­à¸šà¹€à¸¥à¸¢ â€” format: [[query||à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ªà¸”à¸‡]]
        $mainKeyword = $topic['queryPrefix'] ?? $searchTerms[0] ?? $topic['keywords'][0] ?? '';

        $num = 1;
        foreach ($departments as $dept => $label) {
            // à¸•à¸±à¸” emoji à¸­à¸­à¸ à¹€à¸­à¸²à¹à¸„à¹ˆà¸Šà¸·à¹ˆà¸­à¸ªà¸²à¸‚à¸²
            $deptName = preg_replace('/^[^\p{L}]+/u', '', $label);
            $query = "{$mainKeyword}{$deptName}";
            $answer .= "{$num}. [[{$query}||{$label}]]\n";
            $num++;
        }

        $answer .= "\nðŸ’¡ à¸à¸”à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆà¸ªà¸™à¹ƒà¸ˆ à¸«à¸£à¸·à¸­à¸žà¸´à¸¡à¸žà¹Œà¸–à¸²à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢";

        return [
            'answer' => $answer,
            'related_questions' => [],
        ];
    }

    /**
     * à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¹à¸šà¸šà¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸à¸²à¸£ FAQ à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡
     */
    private static function buildFAQListOverview($topic, $faqs) {
        // à¹€à¸¥à¸·à¸­à¸ FAQ à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¸ªà¸¸à¸” + à¹„à¸¡à¹ˆà¸‹à¹‰à¸³à¸à¸±à¸™
        $selectedFAQs = self::selectRepresentativeFAQs($topic, $faqs);

        if (empty($selectedFAQs)) {
            return null;
        }

        $answer = "{$topic['title']}\n\n";
        $answer .= "à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸«à¸¥à¸²à¸¢à¸«à¸±à¸§à¸‚à¹‰à¸­ à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸ªà¸´à¹ˆà¸‡à¸—à¸µà¹ˆà¸ªà¸™à¹ƒà¸ˆ:\n\n";

        foreach ($selectedFAQs as $idx => $faq) {
            $question = explode('|', $faq['question'])[0];
            $question = trim($question);

            // à¹à¸ªà¸”à¸‡à¸ªà¸²à¸‚à¸² (à¸–à¹‰à¸²à¸¡à¸µ)
            $dept = $faq['department'] ?? '';
            $deptSuffix = '';
            if ($dept && $dept !== 'general' && $dept !== 'student_affairs') {
                $deptLabel = ChatbotConfig::$departmentDisplayLabels[$dept] ?? '';
                if ($deptLabel) {
                    // à¹€à¸­à¸²à¹à¸„à¹ˆà¸Šà¸·à¹ˆà¸­à¸ªà¸²à¸‚à¸² (à¸•à¸±à¸” emoji)
                    $deptName = preg_replace('/^[^\p{L}]+/u', '', $deptLabel);
                    $deptSuffix = " ({$deptName})";
                }
            }

            // à¸à¸±à¸‡à¸›à¸¸à¹ˆà¸¡à¸à¸”à¹ƒà¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ â€” [[query||à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ªà¸”à¸‡]]
            $answer .= "[[{$question}||ðŸ“Œ {$question}{$deptSuffix}]]\n";
        }

        // à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸›à¸´à¸”à¸—à¹‰à¸²à¸¢à¸•à¸²à¸¡ topic â€” à¹à¸™à¸°à¸™à¸³à¹ƒà¸«à¹‰à¸£à¸°à¸šà¸¸à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡
        $suggestion = $topic['suggestion'] ?? '';
        if ($suggestion) {
            $answer .= "\nðŸ’¡ à¸à¸”à¹€à¸¥à¸·à¸­à¸à¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸ªà¸™à¹ƒà¸ˆ à¸«à¸£à¸·à¸­à¸žà¸´à¸¡à¸žà¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡ à¹€à¸Šà¹ˆà¸™ {$suggestion}";
        } else {
            $answer .= "\nðŸ’¡ à¸à¸”à¹€à¸¥à¸·à¸­à¸à¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸ªà¸™à¹ƒà¸ˆ à¸«à¸£à¸·à¸­à¸žà¸´à¸¡à¸žà¹Œà¸–à¸²à¸¡à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢";
        }

        return [
            'answer' => $answer,
            'related_questions' => [],
        ];
    }

    /**
     * à¹€à¸¥à¸·à¸­à¸ FAQ à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹à¸—à¸™à¸‚à¸­à¸‡à¸«à¸±à¸§à¸‚à¹‰à¸­ â€” à¸ˆà¸³à¸à¸±à¸” 10 à¸‚à¹‰à¸­ à¹„à¸¡à¹ˆà¸‹à¹‰à¸³
     * à¸ˆà¸±à¸”à¸¥à¸³à¸”à¸±à¸š: FAQ à¸—à¸±à¹ˆà¸§à¹„à¸› (general/à¸£à¸°à¸”à¸±à¸š) à¸à¹ˆà¸­à¸™ â†’ à¸ªà¸²à¸‚à¸²à¹€à¸‰à¸žà¸²à¸°à¸•à¸²à¸¡à¸«à¸¥à¸±à¸‡ (1 à¸‚à¹‰à¸­à¸•à¹ˆà¸­à¸ªà¸²à¸‚à¸²)
     */
    private static function selectRepresentativeFAQs($topic, $faqs) {
        $MAX_ITEMS = 10;
        $selected = [];
        $seenQuestions = [];

        // à¹à¸¢à¸ FAQ à¹€à¸›à¹‡à¸™ 2 à¸à¸¥à¸¸à¹ˆà¸¡: à¸•à¸£à¸‡ searchTerm (à¸ªà¸³à¸„à¸±à¸à¸à¸§à¹ˆà¸²) vs à¸•à¸£à¸‡à¹à¸„à¹ˆ category
        $searchTermMatches = [];
        $categoryOnlyMatches = [];

        // à¸–à¹‰à¸² topic à¸¡à¸µ category à¸à¸³à¸«à¸™à¸”à¹„à¸§à¹‰ â†’ à¹ƒà¸Šà¹‰à¸à¸£à¸­à¸‡ searchTerm matches à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸•à¸£à¸‡ category à¸­à¸­à¸
        $topicCategories = [];
        if (!empty($topic['category'])) {
            $topicCategories = is_array($topic['category']) ? $topic['category'] : [$topic['category']];
        }
        if (!empty($topic['categories'])) {
            $topicCategories = array_merge($topicCategories, $topic['categories']);
        }
        $topicCategories = array_unique($topicCategories);

        foreach ($faqs as $faq) {
            $question = explode('|', $faq['question'])[0];
            $question = trim($question);
            $faqCategory = $faq['category'] ?? '';

            $matchesSearchTerm = false;
            if (!empty($topic['searchTerms'])) {
                foreach ($topic['searchTerms'] as $term) {
                    if (mb_stripos($question, $term) !== false) {
                        $matchesSearchTerm = true;
                        break;
                    }
                }
            }

            if ($matchesSearchTerm) {
                if (!empty($topicCategories) && !in_array($faqCategory, $topicCategories)) {
                    continue;
                }
                $searchTermMatches[] = $faq;
            } else {
                $categoryOnlyMatches[] = $faq;
            }
        }

        // === à¸ˆà¸±à¸”à¸¥à¸³à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸ªà¸³à¸„à¸±à¸ ===
        // 1. FAQ à¸—à¸±à¹ˆà¸§à¹„à¸› (general, undergraduate, vocational, graduate) â†’ à¹à¸ªà¸”à¸‡à¸à¹ˆà¸­à¸™
        // 2. FAQ à¸ªà¸²à¸‚à¸²à¹€à¸‰à¸žà¸²à¸° â†’ à¹à¸ªà¸”à¸‡à¸—à¸µà¸«à¸¥à¸±à¸‡ (à¸ˆà¸³à¸à¸±à¸” 1 à¸‚à¹‰à¸­à¸•à¹ˆà¸­à¸ªà¸²à¸‚à¸²)
        $generalDepts = ['general', 'student_affairs', 'undergraduate', 'vocational', 'graduate', 'vocational_computer'];
        
        $generalFAQs = [];
        $deptFAQs = []; // key = department, value = first FAQ only
        
        $allMatches = array_merge($searchTermMatches, $categoryOnlyMatches);
        
        foreach ($allMatches as $faq) {
            $dept = $faq['department'] ?? 'general';
            if (in_array($dept, $generalDepts)) {
                $generalFAQs[] = $faq;
            } else {
                // à¹€à¸à¹‡à¸šà¹€à¸‰à¸žà¸²à¸° FAQ à¹à¸£à¸à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸°à¸ªà¸²à¸‚à¸² (à¸•à¸±à¸§à¹à¸—à¸™)
                if (!isset($deptFAQs[$dept])) {
                    $deptFAQs[$dept] = $faq;
                }
            }
        }
        
        // à¸£à¸§à¸¡: general à¸à¹ˆà¸­à¸™ â†’ dept à¸•à¸²à¸¡à¸«à¸¥à¸±à¸‡
        $orderedFAQs = array_merge($generalFAQs, array_values($deptFAQs));

        // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸¥à¸¢ à¹ƒà¸Šà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
        if (empty($orderedFAQs)) {
            $orderedFAQs = $faqs;
        }

        foreach ($orderedFAQs as $faq) {
            $question = explode('|', $faq['question'])[0];
            $question = trim($question);

            // à¸•à¸£à¸§à¸ˆà¸‹à¹‰à¸³ â€” à¹€à¸—à¸µà¸¢à¸š 25 chars à¹à¸£à¸
            $qKey = mb_substr($question, 0, 25);
            $isDuplicate = false;
            foreach ($seenQuestions as $seen) {
                if ($qKey === $seen) {
                    $isDuplicate = true;
                    break;
                }
                similar_text($qKey, $seen, $pct);
                if ($pct > 70) {
                    $isDuplicate = true;
                    break;
                }
            }

            if (!$isDuplicate) {
                $selected[] = $faq;
                $seenQuestions[] = $qKey;
            }

            if (count($selected) >= $MAX_ITEMS) break;
        }

        return $selected;
    }

    /**
     * à¸ˆà¸±à¸”à¸à¸¥à¸¸à¹ˆà¸¡à¸¢à¹ˆà¸­à¸¢ FAQ à¸•à¸²à¸¡à¸„à¸³à¸™à¸³à¸«à¸™à¹‰à¸² â€” à¹€à¸Šà¹ˆà¸™ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”, à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™, à¸„à¸¸à¸“à¸ªà¸¡à¸šà¸±à¸•à¸´, à¹€à¸­à¸à¸ªà¸²à¸£
     */
    private static function groupFAQsBySubTopic($faqs) {
        $prefixPatterns = [
            'download'   => ['à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”', 'à¹à¸šà¸šà¸Ÿà¸­à¸£à¹Œà¸¡'],
            'process'    => ['à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™', 'à¸§à¸´à¸˜à¸µ'],
            'qualify'    => ['à¸„à¸¸à¸“à¸ªà¸¡à¸šà¸±à¸•à¸´', 'à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚'],
            'document'   => ['à¹€à¸­à¸à¸ªà¸²à¸£', 'à¹ƒà¸š'],
            'info'       => ['à¸„à¸·à¸­à¸­à¸°à¹„à¸£', 'à¸•à¹ˆà¸²à¸‡à¸à¸±à¸™', 'à¸«à¸¡à¸²à¸¢à¸–à¸¶à¸‡'],
            'other'      => [],
        ];

        $groups = [];
        foreach ($prefixPatterns as $key => $_) {
            $groups[$key] = [];
        }

        foreach ($faqs as $faq) {
            $q = explode('|', $faq['question'])[0];
            $q = trim($q);
            $placed = false;

            foreach ($prefixPatterns as $key => $keywords) {
                foreach ($keywords as $kw) {
                    if (mb_stripos($q, $kw) !== false) {
                        $groups[$key][] = $faq;
                        $placed = true;
                        break 2;
                    }
                }
            }

            if (!$placed) {
                $groups['other'][] = $faq;
            }
        }

        // à¸¥à¸šà¸à¸¥à¸¸à¹ˆà¸¡à¸§à¹ˆà¸²à¸‡
        return array_filter($groups, fn($g) => !empty($g));
    }

    /**
     * à¸ªà¸£à¹‰à¸²à¸‡ sources array à¸ªà¸³à¸«à¸£à¸±à¸š response
     */
    public static function buildSources($faqs) {
        $sources = [];
        foreach ($faqs as $faq) {
            $question = explode('|', $faq['question'])[0];
            $sources[] = [
                'type' => 'faq',
                'id' => $faq['id'],
                'question' => trim($question),
                'department' => $faq['department'] ?? '',
            ];
        }
        return $sources;
    }

    /**
     * à¸”à¸¶à¸‡ topic definitions (à¸ªà¸³à¸«à¸£à¸±à¸š debug/testing)
     */
    public static function getTopicDefinitions() {
        return self::$topicDefinitions;
    }

    // ===========================================================
    // ===== Generic Question Detection (post-FAQ-search) =====
    // à¸ˆà¸±à¸”à¸à¸²à¸£à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆà¸¢à¸²à¸§à¸à¸§à¹ˆà¸² (>30 chars) à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸ªà¸²à¸‚à¸²
    // à¹€à¸Šà¹ˆà¸™ "à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ" â†’ à¹à¸ªà¸”à¸‡à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²
    // ===========================================================

    /**
     * à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™ Generic Question à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ (à¸«à¸¥à¸±à¸‡ FAQ search)
     */
    public static function isGenericQuestion($message, $faqResults) {
        // à¸•à¸£à¸§à¸ˆ universal keyword (à¸—à¸¸à¸à¸ªà¸²à¸‚à¸²à¹€à¸«à¸¡à¸·à¸­à¸™à¸à¸±à¸™) â†’ à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ Generic
        foreach (ChatbotConfig::$universalKeywords as $uk) {
            if (mb_stripos($message, $uk) !== false) {
                return false;
            }
        }

        // à¸•à¸£à¸§à¸ˆ generic keyword (à¹€à¸‰à¸žà¸²à¸°à¸ªà¸²à¸‚à¸²)
        $hasGenericKeyword = false;
        foreach (ChatbotConfig::$genericKeywords as $gk) {
            if (mb_stripos($message, $gk) !== false) {
                $hasGenericKeyword = true;
                break;
            }
        }
        if (!$hasGenericKeyword) return false;

        // à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸²à¸£à¸°à¸šà¸¸à¸ªà¸²à¸‚à¸²à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
        foreach (ChatbotConfig::$departmentDetectKeywords as $dept) {
            if (mb_stripos($message, $dept) !== false) {
                return false;
            }
        }

        // à¸–à¹‰à¸²à¸¡à¸µ generic keyword à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸¡à¸µà¸Šà¸·à¹ˆà¸­à¸ªà¸²à¸‚à¸² à¹à¸¥à¸°à¸¡à¸µ FAQ à¸«à¸¥à¸²à¸¢à¸­à¸±à¸™
        return ($hasGenericKeyword && count($faqResults) >= 2);
    }

    /**
     * à¸”à¸¶à¸‡ department-specific answers à¸ˆà¸²à¸à¸œà¸¥ FAQ search
     */
    public static function getDepartmentSpecificAnswers($faqResults) {
        $departmentAnswers = [];
        $seenDepartments = [];
        $bestScore = floatval($faqResults[0]['relevance']);

        foreach ($faqResults as $faq) {
            $faqScore = floatval($faq['relevance']);
            $scoreDiff = abs($bestScore - $faqScore);
            $scoreRatio = $bestScore > 0 ? ($scoreDiff / $bestScore) : 1;

            if ($scoreRatio <= 0.8 && $faqScore >= 30) {
                $dept = $faq['department'] ?? 'general';
                if ($dept === 'general') continue;

                $question = explode('|', $faq['question'])[0];

                if (!in_array($dept, $seenDepartments)) {
                    $seenDepartments[] = $dept;
                    $departmentAnswers[] = [
                        'id' => $faq['id'],
                        'question' => trim($question),
                        'department' => $dept,
                        'score' => $faqScore,
                        'category' => $faq['category'] ?? 'general',
                    ];
                } else {
                    // à¸ªà¸²à¸‚à¸²à¹€à¸”à¸´à¸¡ â€” à¹€à¸¥à¸·à¸­à¸ FAQ à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸à¸§à¹ˆà¸² (à¸›.à¸•à¸£à¸µ > à¸›.à¹‚à¸—)
                    foreach ($departmentAnswers as $idx => $existing) {
                        if ($existing['department'] === $dept) {
                            $existingHasMaster = (mb_strpos($existing['question'], 'à¸›.à¹‚à¸—') !== false);
                            $newHasMaster = (mb_strpos($question, 'à¸›.à¹‚à¸—') !== false);
                            if (($existingHasMaster && !$newHasMaster) || (!$existingHasMaster && !$newHasMaster && $faqScore > $existing['score'])) {
                                $departmentAnswers[$idx] = [
                                    'id' => $faq['id'],
                                    'question' => trim($question),
                                    'department' => $dept,
                                    'score' => $faqScore,
                                    'category' => $faq['category'] ?? 'general',
                                ];
                            }
                            break;
                        }
                    }
                }
            }
            if (count($departmentAnswers) >= 12) break;
        }
        return $departmentAnswers;
    }

    /**
     * à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¹à¸šà¸šà¹à¸ªà¸”à¸‡à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸² (à¸«à¸¥à¸±à¸‡ FAQ search)
     */
    public static function buildGenericAnswer($departmentAnswers) {
        $answer = "ðŸ“Š à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸•à¸à¸•à¹ˆà¸²à¸‡à¸à¸±à¸™à¹ƒà¸™à¹à¸•à¹ˆà¸¥à¸°à¸ªà¸²à¸‚à¸²\n\n";
        $answer .= "à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸–à¸²à¸¡à¸¡à¸µà¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¹à¸•à¸à¸•à¹ˆà¸²à¸‡à¸à¸±à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸•à¹ˆà¸¥à¸°à¸ªà¸²à¸‚à¸²\n";
        $answer .= "à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸ªà¸™à¹ƒà¸ˆ:\n\n";

        foreach ($departmentAnswers as $idx => $deptAnswer) {
            $deptName = ChatbotConfig::$departmentDisplayLabels[$deptAnswer['department']] ?? $deptAnswer['department'];
            $answer .= ($idx + 1) . ". " . $deptName . "\n";
            // à¸à¸±à¸‡à¸›à¸¸à¹ˆà¸¡à¸à¸”à¹ƒà¸™à¸„à¸³à¸•à¸­à¸š â€” [[query||à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ªà¸”à¸‡]]
            $answer .= "   [[" . $deptAnswer['question'] . "||ðŸ“ " . $deptAnswer['question'] . "]]\n\n";
        }

        $answer .= "ðŸ’¡ à¸à¸”à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆà¸ªà¸™à¹ƒà¸ˆ à¸«à¸£à¸·à¸­à¸žà¸´à¸¡à¸žà¹Œà¸–à¸²à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢";

        return [
            'answer' => $answer,
            'related_questions' => [],
        ];
    }

    /**
     * à¸ªà¸£à¹‰à¸²à¸‡ sources à¸ªà¸³à¸«à¸£à¸±à¸š generic answer
     */
    public static function buildGenericSources($departmentAnswers) {
        $sources = [];
        foreach ($departmentAnswers as $deptAnswer) {
            $sources[] = [
                'type' => 'faq',
                'id' => $deptAnswer['id'],
                'question' => $deptAnswer['question'],
                'department' => $deptAnswer['department'],
            ];
        }
        return $sources;
    }
}
