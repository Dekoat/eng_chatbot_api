<?php
/**
 * à¸—à¸”à¸ªà¸­à¸š Chatbot - à¹à¸ªà¸”à¸‡à¸œà¸¥à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢
 */
header('Content-Type: text/plain; charset=utf-8');
require_once __DIR__ . '/../../backend/chatbot.php';

$chatbot = new Chatbot();

// à¸£à¸²à¸¢à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸š: [à¸„à¸³à¸–à¸²à¸¡, à¸„à¸³à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸ˆà¸­à¹ƒà¸™à¸„à¸³à¸•à¸­à¸š, à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢]
$tests = [
    // === BroadTopic (à¸«à¸±à¸§à¸‚à¹‰à¸­à¸à¸§à¹‰à¸²à¸‡) ===
    ['à¸—à¸¸à¸™à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²',     'à¸—à¸¸à¸™',          'à¸«à¸±à¸§à¸‚à¹‰à¸­à¸à¸§à¹‰à¸²à¸‡: à¸—à¸¸à¸™à¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²'],
    ['à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡',         'à¸ªà¸²à¸‚à¸²',         'à¸«à¸±à¸§à¸‚à¹‰à¸­à¸à¸§à¹‰à¸²à¸‡: à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡ (à¹à¸ªà¸”à¸‡à¸ªà¸²à¸‚à¸²)'],
    ['à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£',        'à¸ªà¸²à¸‚à¸²',         'à¸«à¸±à¸§à¸‚à¹‰à¸­à¸à¸§à¹‰à¸²à¸‡: à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£'],
    ['à¸à¸¢à¸¨',             'à¸à¸¢à¸¨',          'à¸«à¸±à¸§à¸‚à¹‰à¸­à¸à¸§à¹‰à¸²à¸‡: à¸à¸­à¸‡à¸—à¸¸à¸™ à¸à¸¢à¸¨'],

    // === à¸„à¸³à¸–à¸²à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸› (Generic) ===
    ['à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ', 'à¸ªà¸²à¸‚à¸²',        'à¸„à¸³à¸–à¸²à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸›: à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸ªà¸²à¸‚à¸²'],

    // === à¸„à¸³à¸–à¸²à¸¡à¹€à¸ˆà¸²à¸°à¸ˆà¸‡ ===
    ['à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸§à¸´à¸¨à¸§à¸à¸£à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ', 'à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ', 'à¹€à¸ˆà¸²à¸°à¸ˆà¸‡: à¸„à¹ˆà¸²à¹€à¸—à¸­à¸¡à¸ªà¸²à¸‚à¸²à¸„à¸­à¸¡à¸¯'],
    ['à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸ˆà¸šà¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²',          'à¸ˆà¸š',           'à¹€à¸ˆà¸²à¸°à¸ˆà¸‡: à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸ˆà¸šà¸à¸²à¸£à¸¨à¸¶à¸à¸©à¸²'],
    ['à¸£à¸µà¹„à¸—à¸£à¹Œ',                       'à¸£à¸µà¹„à¸—à¸£à¹Œ',       'à¹€à¸ˆà¸²à¸°à¸ˆà¸‡: à¸žà¹‰à¸™à¸ªà¸ à¸²à¸ž/à¸£à¸µà¹„à¸—à¸£à¹Œ'],

    // === à¸„à¹‰à¸™à¸«à¸²à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ ===
    ['à¸­.à¹€à¸à¸£à¸´à¸',         'à¹€à¸à¸£à¸´à¸',        'à¸„à¹‰à¸™à¸«à¸²à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ: à¸­.à¹€à¸à¸£à¸´à¸'],
    ['à¸œà¸¨.à¸”à¸£.',          'à¸œà¸¨',           'à¸„à¹‰à¸™à¸«à¸²à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ: à¸œà¸¨.à¸”à¸£.'],

    // === à¸‚à¹ˆà¸²à¸§à¸ªà¸²à¸£ ===
    ['à¸‚à¹ˆà¸²à¸§à¸ªà¸²à¸£',         'à¸‚à¹ˆà¸²à¸§',         'à¸„à¹‰à¸™à¸«à¸²à¸‚à¹ˆà¸²à¸§à¸¥à¹ˆà¸²à¸ªà¸¸à¸”'],

    // === à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆ AI à¸•à¹‰à¸­à¸‡à¹„à¸¡à¹ˆà¸ªà¸±à¸šà¸ªà¸™ ===
    ['à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œà¸—à¸µà¹ˆà¸›à¸£à¸¶à¸à¸©à¸²', 'à¸›à¸£à¸¶à¸à¸©à¸²',     'à¸šà¸£à¸´à¸šà¸—: à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸„à¹‰à¸™à¸«à¸²à¸­à¸²à¸ˆà¸²à¸£à¸¢à¹Œ â†’ FAQ'],
    ['à¸ªà¸¡à¸±à¸„à¸£à¹€à¸£à¸µà¸¢à¸™',       'à¸ªà¸¡à¸±à¸„à¸£',       'à¹€à¸ˆà¸²à¸°à¸ˆà¸‡: à¸à¸²à¸£à¸ªà¸¡à¸±à¸„à¸£à¹€à¸£à¸µà¸¢à¸™'],
];

echo "============================================\n";
echo "   à¸—à¸”à¸ªà¸­à¸šà¸£à¸°à¸šà¸š Chatbot RMUTP\n";
echo "   à¸§à¸±à¸™à¸—à¸µà¹ˆ: " . date('Y-m-d H:i:s') . "\n";
echo "============================================\n\n";

$pass = 0;
$fail = 0;
$errors = [];

foreach ($tests as $i => $test) {
    $question   = $test[0];
    $expected   = $test[1];
    $desc       = $test[2];
    $num        = $i + 1;

    try {
        $result = $chatbot->handleChat('test_' . md5($question), $question);
        $answer = $result['answer'] ?? '';
        $found  = mb_strpos($answer, $expected) !== false;

        if ($found) {
            $pass++;
            echo "  âœ… à¸œà¹ˆà¸²à¸™ #{$num}: {$desc}\n";
        } else {
            $fail++;
            // à¸•à¸±à¸”à¸„à¸³à¸•à¸­à¸šà¹ƒà¸«à¹‰à¸ªà¸±à¹‰à¸™
            $short = mb_substr($answer, 0, 80);
            echo "  âŒ à¹„à¸¡à¹ˆà¸œà¹ˆà¸²à¸™ #{$num}: {$desc}\n";
            echo "     à¸„à¸³à¸–à¸²à¸¡: {$question}\n";
            echo "     à¸„à¸²à¸”à¸«à¸§à¸±à¸‡: \"{$expected}\"\n";
            echo "     à¹„à¸”à¹‰à¸£à¸±à¸š: \"{$short}...\"\n";
            $errors[] = $num;
        }
    } catch (Exception $e) {
        $fail++;
        echo "  ðŸ’¥ à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸” #{$num}: {$desc}\n";
        echo "     " . $e->getMessage() . "\n";
        $errors[] = $num;
    }
}

echo "\n============================================\n";
echo "   à¸ªà¸£à¸¸à¸›à¸œà¸¥: à¸œà¹ˆà¸²à¸™ {$pass}/{$num} | à¹„à¸¡à¹ˆà¸œà¹ˆà¸²à¸™ {$fail}/{$num}\n";
if (count($errors) > 0) {
    echo "   à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸œà¹ˆà¸²à¸™: #" . implode(', #', $errors) . "\n";
}
echo "============================================\n";
