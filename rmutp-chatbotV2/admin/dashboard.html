<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RMUTP Chatbot Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Sarabun', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #F7F7F8;
            -webkit-font-smoothing: antialiased;
        }
        
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #FFFFFF;
            border-right: 1px solid #E5E5E5;
            display: flex;
            flex-direction: column;
            padding: 20px 14px;
        }
        
        .sidebar-header {
            padding: 14px 16px;
            margin-bottom: 24px;
            background: linear-gradient(145deg, #fff, #F7F7F8);
            border-radius: 14px;
            border: 1px solid rgba(148, 0, 50, 0.08);
            box-shadow: 0 4px 12px rgba(20, 20, 20, 0.04);
        }
        
        .sidebar-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #940032;
            letter-spacing: -0.01em;
            margin-bottom: 2px;
        }
        
        .sidebar-header p {
            font-size: 12px;
            color: #6B6B6B;
        }
        
        .nav-menu {
            list-style: none;
            flex: 1;
        }
        
        .nav-item {
            margin-bottom: 2px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            color: #6B6B6B;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.15s ease;
            cursor: pointer;
            font-size: 14px;
        }
        
        .nav-link:hover {
            background: #F7F7F8;
            color: #2D2D2D;
        }

        .nav-link.active {
            background: #F7F7F8;
            color: #2D2D2D;
            font-weight: 500;
        }
        
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .nav-icon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .nav-link.active .nav-icon svg {
            stroke: #940032;
        }
        
        .logout-btn {
            margin-top: auto;
            width: 100%;
            padding: 10px 14px;
            background: transparent;
            border: 1px solid #E5E5E5;
            color: #6B6B6B;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .logout-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .logout-btn:hover {
            background: #FEF2F2;
            border-color: #FECACA;
            color: #991B1B;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .topbar {
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 28px;
            border-bottom: 1px solid #E5E5E5;
            background: #FFFFFF;
            flex-shrink: 0;
        }
        
        .topbar h1 {
            font-size: 18px;
            font-weight: 500;
            color: #2D2D2D;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .user-avatar {
            width: 34px;
            height: 34px;
            background: #940032;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-label {
            font-weight: 500;
            font-size: 14px;
            color: #2D2D2D;
        }

        .user-role {
            font-size: 12px;
            color: #6B6B6B;
        }

        .content-area {
            flex: 1;
            padding: 24px 28px;
            overflow-y: auto;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: #FFFFFF;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #E5E5E5;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            transition: box-shadow 0.2s ease;
        }
        
        .stat-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .stat-title {
            font-size: 13px;
            color: #6B6B6B;
            font-weight: 500;
        }
        
        .stat-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: #2D2D2D;
        }
        
        .stat-change {
            font-size: 12px;
            margin-top: 4px;
            color: #6B6B6B;
        }
        
        .stat-change.positive {
            color: #059669;
        }
        
        /* Content Section */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 500;
            color: #2D2D2D;
        }
        
        .btn-primary {
            padding: 9px 18px;
            background: #940032;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary svg {
            width: 15px;
            height: 15px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .btn-primary:hover {
            background: #7a0028;
            box-shadow: 0 2px 8px rgba(148, 0, 50, 0.2);
        }
        
        /* Table */
        .data-table {
            background: #FFFFFF;
            border-radius: 12px;
            border: 1px solid #E5E5E5;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #F7F7F8;
        }
        
        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            color: #6B6B6B;
            font-size: 13px;
            letter-spacing: 0.01em;
        }
        
        td {
            padding: 12px 16px;
            border-top: 1px solid #ECECF1;
            color: #2D2D2D;
            font-size: 14px;
        }
        
        tbody tr:hover {
            background: #F7F7F8;
        }
        
        .badge {
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-active, .badge-success {
            background: #ECFDF5;
            color: #065F46;
        }
        
        .badge-inactive, .badge-danger {
            background: #FEF2F2;
            color: #991B1B;
        }
        
        .badge-warning {
            background: #FFFBEB;
            color: #92400E;
        }
        
        .badge-info {
            background: #EFF6FF;
            color: #1E40AF;
        }
        
        .action-btns {
            display: flex;
            gap: 6px;
        }
        
        .btn-edit,
        .btn-delete {
            padding: 5px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.15s;
        }
        
        .btn-edit {
            background: #EFF6FF;
            color: #1E40AF;
        }

        .btn-edit:hover {
            background: #DBEAFE;
        }
        
        .btn-delete {
            background: #FEF2F2;
            color: #991B1B;
        }

        .btn-delete:hover {
            background: #FEE2E2;
        }
        
        .loading {
            text-align: center;
            padding: 32px;
            color: #6B6B6B;
        }
        
        .search-filter {
            background: #FFFFFF;
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid #E5E5E5;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 9px 14px;
            border: 1.5px solid #E5E5E5;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            color: #2D2D2D;
            transition: border-color 0.15s;
        }

        .search-input:focus {
            outline: none;
            border-color: #940032;
        }
        
        .filter-select {
            padding: 9px 14px;
            border: 1.5px solid #E5E5E5;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            min-width: 140px;
            color: #2D2D2D;
            background: #FFFFFF;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
        }
        
        .page-btn {
            padding: 7px 12px;
            border: 1px solid #E5E5E5;
            background: #FFFFFF;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            color: #2D2D2D;
            transition: all 0.15s;
        }

        .page-btn:hover {
            border-color: #940032;
            color: #940032;
        }
        
        .page-btn.active {
            background: #940032;
            color: white;
            border-color: #940032;
        }
        
        .page-info {
            color: #6B6B6B;
            font-size: 13px;
        }
        
        /* Quick Access */
        .quick-access {
            background: #FFFFFF;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid #E5E5E5;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .quick-access-title {
            font-size: 14px;
            font-weight: 500;
            color: #6B6B6B;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-access-title svg {
            width: 16px;
            height: 16px;
            stroke: #940032;
            fill: none;
            stroke-width: 2;
        }

        .quick-access-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .quick-card {
            padding: 16px;
            border-radius: 10px;
            text-decoration: none;
            color: #2D2D2D;
            transition: all 0.15s ease;
            border: 1px solid #E5E5E5;
            background: #F7F7F8;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-card:hover {
            border-color: #940032;
            box-shadow: 0 2px 8px rgba(148, 0, 50, 0.08);
            background: #FFFFFF;
        }

        .quick-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-card-icon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .quick-card-label {
            font-weight: 500;
            font-size: 14px;
        }

        .quick-card-desc {
            font-size: 12px;
            color: #6B6B6B;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
        }
        
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #FFFFFF;
            border-radius: 14px;
            width: 90%;
            max-width: 560px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #E5E5E5;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            border-bottom: 1px solid #E5E5E5;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #940032;
            font-size: 16px;
            font-weight: 600;
        }
        
        .close-modal {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            color: #6B6B6B;
            font-size: 20px;
            transition: all 0.15s;
        }
        
        .close-modal:hover {
            background: #F7F7F8;
            color: #2D2D2D;
        }
        
        .form-group {
            margin: 16px 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #2D2D2D;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #E5E5E5;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            color: #2D2D2D;
            transition: border-color 0.15s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #940032;
        }
        
        .form-group textarea {
            resize: vertical;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 16px 20px;
            border-top: 1px solid #E5E5E5;
        }
        
        .btn-secondary {
            padding: 9px 18px;
            border: 1px solid #E5E5E5;
            background: #FFFFFF;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            color: #6B6B6B;
            transition: all 0.15s;
        }
        
        .btn-secondary:hover {
            background: #F7F7F8;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>RMUTP Admin</h2>
                <p>Chatbot Management</p>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-section="dashboard">
                        <span class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg></span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="faqs">
                        <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
                        <span>FAQ Management</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="chatlogs">
                        <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span>
                        <span>Chat Logs</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="news">
                        <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><line x1="10" y1="6" x2="18" y2="6"/><line x1="10" y1="10" x2="18" y2="10"/><line x1="10" y1="14" x2="14" y2="14"/></svg></span>
                        <span>News Management</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="staff">
                        <span class="nav-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span>
                        <span>Staff Management</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="analytics.html" class="nav-link" target="_blank">
                        <span class="nav-icon"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>
                        <span>Analytics Dashboard</span>
                    </a>
                </li>
            </ul>
            
            <button class="logout-btn" onclick="logout()">
                <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                ออกจากระบบ
            </button>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="topbar">
                <h1 id="pageTitle">Dashboard</h1>
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div>
                        <div class="user-label">Admin</div>
                        <div class="user-role">ผู้ดูแลระบบ</div>
                    </div>
                </div>
            </div>

            <div class="content-area">
            
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <!-- Quick Access Section -->
                <div class="quick-access">
                    <div class="quick-access-title">
                        <svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        Quick Access
                    </div>
                    <div class="quick-access-grid">
                        <a href="analytics.html" target="_blank" class="quick-card">
                            <div class="quick-card-icon" style="background: #EFF6FF; color: #1E40AF;">
                                <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                            </div>
                            <div class="quick-card-label">Analytics Dashboard</div>
                            <div class="quick-card-desc">ดูสถิติและวิเคราะห์ระบบ</div>
                        </a>
                        <a href="#" onclick="checkFeedbackStats(); return false;" class="quick-card">
                            <div class="quick-card-icon" style="background: #ECFDF5; color: #065F46;">
                                <svg viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>
                            </div>
                            <div class="quick-card-label">Feedback Stats</div>
                            <div class="quick-card-desc" id="feedbackQuickStats">กำลังโหลด...</div>
                        </a>
                        <a href="#" onclick="checkAIStatus(); return false;" class="quick-card">
                            <div class="quick-card-icon" style="background: #FFF7ED; color: #9A3412;">
                                <svg viewBox="0 0 24 24"><path d="M12 2a4 4 0 0 1 4 4c0 1.95-1.4 3.58-3.25 3.93L12 22"/><path d="M12 2a4 4 0 0 0-4 4c0 1.95 1.4 3.58 3.25 3.93"/><line x1="4.5" y1="9" x2="8" y2="11"/><line x1="19.5" y1="9" x2="16" y2="11"/><circle cx="12" cy="5" r="1"/></svg>
                            </div>
                            <div class="quick-card-label">AI Server Status</div>
                            <div class="quick-card-desc" id="aiServerStatus">กำลังตรวจสอบ...</div>
                        </a>
                        <a href="../frontend/index.html" target="_blank" class="quick-card">
                            <div class="quick-card-icon" style="background: #FDF2F8; color: #9D174D;">
                                <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            </div>
                            <div class="quick-card-label">Test Chatbot</div>
                            <div class="quick-card-desc">ทดสอบระบบ Chatbot</div>
                        </a>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Total FAQs</span>
                            <div class="stat-icon" style="background: #EFF6FF; color: #1E40AF;">
                                <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            </div>
                        </div>
                        <div class="stat-value" id="totalFaqs">-</div>
                        <div class="stat-change">FAQ ทั้งหมดในระบบ</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Total Conversations</span>
                            <div class="stat-icon" style="background: #ECFDF5; color: #065F46;">
                                <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            </div>
                        </div>
                        <div class="stat-value" id="totalChats">-</div>
                        <div class="stat-change" id="totalChatsLabel">การสนทนาทั้งหมด</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Today's Chats</span>
                            <div class="stat-icon" style="background: #FFFBEB; color: #92400E;">
                                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </div>
                        </div>
                        <div class="stat-value" id="activeSessions">-</div>
                        <div class="stat-change">วันนี้</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Avg Confidence</span>
                            <div class="stat-icon" style="background: #FDF2F8; color: #9D174D;">
                                <svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            </div>
                        </div>
                        <div class="stat-value" id="avgResponse">-</div>
                        <div class="stat-change">ความมั่นใจเฉลี่ย</div>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2 class="section-title">Recent Chat Logs</h2>
                </div>
                
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>เวลา</th>
                                <th>คำถาม</th>
                                <th>Confidence</th>
                                <th>Response Time</th>
                            </tr>
                        </thead>
                        <tbody id="recentChats">
                            <tr>
                                <td colspan="4" class="loading">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- FAQ Management Section -->
            <section id="faqs" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">FAQ Management</h2>
                    <button class="btn-primary" onclick="openCreateFAQModal()"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> เพิ่ม FAQ ใหม่</button>
                </div>
                
                <div class="search-filter">
                    <input type="text" class="search-input" id="faqSearch" placeholder="ค้นหาคำถาม...">
                    <select class="filter-select" id="categoryFilter">
                        <option value="">ทุกหมวดหมู่</option>
                    </select>
                    <button class="btn-primary" onclick="loadFAQs()"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> รีเฟรช</button>
                </div>
                
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>คำถาม</th>
                                <th>หมวดหมู่</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="faqList">
                            <tr>
                                <td colspan="5" class="loading">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="faqPagination"></div>
            </section>
            
            <!-- Chat Logs Section -->
            <section id="chatlogs" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Chat Logs</h2>
                    <button class="btn-primary" onclick="exportChatLogsCSV()"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Export CSV</button>
                </div>
                
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>ข้อความ</th>
                                <th>เวลา</th>
                                <th>Confidence</th>
                                <th>Response Time</th>
                            </tr>
                        </thead>
                        <tbody id="chatLogsList">
                            <tr>
                                <td colspan="5" class="loading">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- News Section -->
            <section id="news" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">News Management</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-primary" onclick="openCreateNewsModal()"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> เพิ่มข่าวใหม่</button>
                        <button class="btn-primary" onclick="scrapeNews()"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Scrape Now</button>
                    </div>
                </div>
                
                <div class="search-filter">
                    <input type="text" class="search-input" id="newsSearch" placeholder="ค้นหาข่าว...">
                    <select class="filter-select" id="newsCategoryFilter">
                        <option value="">ทุกหมวดหมู่</option>
                        <option value="ข่าวประชาสัมพันธ์">ข่าวประชาสัมพันธ์</option>
                        <option value="กิจกรรม">กิจกรรม</option>
                    </select>
                    <button class="btn-primary" onclick="loadNews()"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> รีเฟรช</button>
                </div>
                
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>หัวข้อ</th>
                                <th>หมวดหมู่</th>
                                <th>วันที่เผยแพร่</th>
                                <th>Views</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="newsList">
                            <tr>
                                <td colspan="7" class="loading">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="newsPagination"></div>
            </section>
            
            <!-- Staff Section -->
            <section id="staff" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Staff Management</h2>
                </div>
                
                <div class="search-filter">
                    <input type="text" class="search-input" id="staffSearch" placeholder="ค้นหาชื่อ...">
                    <select class="filter-select" id="departmentFilter">
                        <option value="">ทุกภาควิชา</option>
                    </select>
                    <button class="btn-primary" onclick="loadStaff()"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> รีเฟรช</button>
                </div>
                
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ชื่อ</th>
                                <th>ภาควิชา</th>
                                <th>ตำแหน่ง</th>
                                <th>อีเมล</th>
                                <th>โทรศัพท์</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="staffList">
                            <tr>
                                <td colspan="7" class="loading">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="staffPagination"></div>
            </section>
            </div>
        </main>
    </div>
    
    <!-- FAQ Modal -->
    <div id="faqModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">เพิ่ม FAQ ใหม่</h3>
                <span class="close-modal" onclick="closeFAQModal()">&times;</span>
            </div>
            <form id="faqForm" onsubmit="saveFAQ(event)">
                <input type="hidden" id="faqId" value="">
                
                <div class="form-group">
                    <label for="faqQuestion">คำถาม *</label>
                    <textarea id="faqQuestion" rows="3" required placeholder="กรอกคำถาม..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="faqAnswer">คำตอบ *</label>
                    <textarea id="faqAnswer" rows="5" required placeholder="กรอกคำตอบ..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="faqCategory">หมวดหมู่ *</label>
                    <input type="text" id="faqCategory" required placeholder="เช่น การรับสมัคร, ค่าธรรมเนียม">
                </div>
                
                <div class="form-group">
                    <label for="faqKeywords">คำสำคัญ (คั่นด้วยเครื่องหมายจุลภาค)</label>
                    <input type="text" id="faqKeywords" placeholder="คำสำคัญ1, คำสำคัญ2, ...">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeFAQModal()">ยกเลิก</button>
                    <button type="submit" class="btn-primary">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Staff Modal -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>แก้ไขข้อมูลบุคลากร</h3>
                <span class="close-modal" onclick="closeStaffModal()">&times;</span>
            </div>
            <form id="staffForm" onsubmit="saveStaff(event)">
                <input type="hidden" id="staffId" value="">
                
                <div class="form-group">
                    <label for="staffNameTh">ชื่อภาษาไทย *</label>
                    <input type="text" id="staffNameTh" required>
                </div>
                
                <div class="form-group">
                    <label for="staffNameEn">ชื่อภาษาอังกฤษ</label>
                    <input type="text" id="staffNameEn">
                </div>
                
                <div class="form-group">
                    <label for="staffDepartment">ภาควิชา *</label>
                    <input type="text" id="staffDepartment" required>
                </div>
                
                <div class="form-group">
                    <label for="staffPosition">ตำแหน่ง</label>
                    <input type="text" id="staffPosition">
                </div>
                
                <div class="form-group">
                    <label for="staffEmail">อีเมล</label>
                    <input type="email" id="staffEmail">
                </div>
                
                <div class="form-group">
                    <label for="staffPhone">เบอร์โทรศัพท์</label>
                    <input type="tel" id="staffPhone">
                </div>
                
                <div class="form-group">
                    <label for="staffRoom">ห้องทำงาน</label>
                    <input type="text" id="staffRoom">
                </div>
                
                <div class="form-group">
                    <label for="staffOfficeHours">เวลาทำการ</label>
                    <input type="text" id="staffOfficeHours">
                </div>
                
                <div class="form-group">
                    <label for="staffAvailability">การนัดหมาย</label>
                    <input type="text" id="staffAvailability">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeStaffModal()">ยกเลิก</button>
                    <button type="submit" class="btn-primary">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- News Modal -->
    <div id="newsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="newsModalTitle">เพิ่มข่าวใหม่</h3>
                <span class="close-modal" onclick="closeNewsModal()">&times;</span>
            </div>
            <form id="newsForm" onsubmit="saveNews(event)">
                <input type="hidden" id="newsId" value="">
                
                <div class="form-group">
                    <label for="newsTitle">หัวข้อข่าว *</label>
                    <input type="text" id="newsTitle" required placeholder="หัวข้อข่าว">
                </div>
                
                <div class="form-group">
                    <label for="newsContent">เนื้อหา *</label>
                    <textarea id="newsContent" rows="6" required placeholder="เนื้อหาข่าว"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="newsSummary">สรุปย่อ</label>
                    <textarea id="newsSummary" rows="2" placeholder="สรุปข่าวสั้น ๆ (จะแสดงในหน้ารายการ)"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="newsCategory">หมวดหมู่ *</label>
                    <select id="newsCategory" required>
                        <option value="ข่าวประชาสัมพันธ์">ข่าวประชาสัมพันธ์</option>
                        <option value="กิจกรรม">กิจกรรม</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newsPublishedDate">วันที่เผยแพร่</label>
                    <input type="date" id="newsPublishedDate">
                </div>
                
                <div class="form-group">
                    <label for="newsLinkUrl">ลิงก์ข่าวต้นทาง</label>
                    <input type="url" id="newsLinkUrl" placeholder="https://...">
                </div>
                
                <div class="form-group">
                    <label for="newsThumbnailUrl">URL รูปภาพ</label>
                    <input type="url" id="newsThumbnailUrl" placeholder="https://...">
                </div>
                
                <div class="form-group">
                    <label for="newsTags">Tags (คั่นด้วยจุลภาค)</label>
                    <input type="text" id="newsTags" placeholder="tag1, tag2, tag3">
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeNewsModal()">ยกเลิก</button>
                    <button type="submit" class="btn-primary">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // ==================== Helper Functions ====================
        
        function getToken() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                handleUnauthorized();
                return null;
            }
            return token;
        }
        
        function handleUnauthorized() {
            alert('Session หมดอายุ กรุณาเข้าสู่ระบบใหม่');
            localStorage.removeItem('admin_token');
            window.location.href = 'login.html';
        }
        
        function showError(message) {
            console.error(message);
            alert(message);
        }
        
        function showSuccess(message) {
            alert(message);
        }
        
        // ==================== Authentication Check ====================
        
        // AI Server URL (change for production)
        const AI_SERVER_URL = 'http://localhost:5000';

        // Check authentication on page load
        const token = localStorage.getItem('admin_token');
        if (!token) {
            window.location.href = 'login.html';
        }
        
        // ==================== Navigation ====================
        
        // Navigation
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.content-section');
        const pageTitle = document.getElementById('pageTitle');
        
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                const sectionName = link.dataset.section;
                
                // Update active nav
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                // Update active section
                sections.forEach(s => s.classList.remove('active'));
                document.getElementById(sectionName).classList.add('active');
                
                // Update page title
                const titles = {
                    'dashboard': 'Dashboard',
                    'faqs': 'FAQ Management',
                    'chatlogs': 'Chat Logs',
                    'news': 'News Management',
                    'staff': 'Staff Management'
                };
                pageTitle.textContent = titles[sectionName];
                
                // Load data for section
                if (sectionName === 'faqs') loadFAQs();
                else if (sectionName === 'chatlogs') loadChatLogs();
                else if (sectionName === 'news') loadNews();
                else if (sectionName === 'staff') loadStaff();
            });
        });
        
        // Load dashboard stats
        async function loadDashboardStats() {
            const token = getToken();
            if (!token) return;
            
            try {
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'get_stats',
                        token: token
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    if (response.status === 401) {
                        handleUnauthorized();
                    }
                    throw new Error(data.error || 'Failed to load stats');
                }
                
                // Update stats from API
                document.getElementById('totalFaqs').textContent = data.data.total_faqs || '0';
                document.getElementById('totalChats').textContent = data.data.total_chats || '0';
                document.getElementById('activeSessions').textContent = data.data.today_chats || '0';
                document.getElementById('avgResponse').textContent = 
                    (data.data.avg_confidence || 0).toFixed(2) + '%';
                
                // Load quick access stats
                loadQuickAccessStats();
                
                // Load recent chats
                loadRecentChats();
                
            } catch (error) {
                console.error('Error loading stats:', error);
                showError('ไม่สามารถโหลดสถิติได้: ' + error.message);
            }
        }
        
        async function loadQuickAccessStats() {
            // Load Feedback Stats
            try {
                const response = await fetch('../backend/analytics_api.php?action=feedback_stats');
                const data = await response.json();
                if (data.success) {
                    const positive = data.stats.find(s => s.feedback_type === 'positive') || {count: 0};
                    const negative = data.stats.find(s => s.feedback_type === 'negative') || {count: 0};
                    document.getElementById('feedbackQuickStats').textContent = 
                        `+${positive.count} / -${negative.count} (ทั้งหมด ${data.total})`;
                }
            } catch (error) {
                document.getElementById('feedbackQuickStats').textContent = 'ไม่มีข้อมูล';
            }
            
            // Check AI Server Status
            try {
                const response = await fetch(`${AI_SERVER_URL}/health`);
                const data = await response.json();
                if (data.status === 'healthy') {
                    document.getElementById('aiServerStatus').innerHTML = 
                        '<span style="color: #059669;">Online</span> — Model loaded';
                } else {
                    document.getElementById('aiServerStatus').innerHTML = 
                        '<span style="color: #D97706;">Running</span> — Check model';
                }
            } catch (error) {
                document.getElementById('aiServerStatus').innerHTML = 
                    '<span style="color: #DC2626;">Offline</span> — Server down';
            }
        }
        
        async function checkFeedbackStats() {
            window.open('analytics.html#feedback', '_blank');
        }
        
        async function checkAIStatus() {
            try {
                const response = await fetch(`${AI_SERVER_URL}/health`);
                const data = await response.json();
                alert(`AI Server Status\n\nStatus: ${data.status}\nModel Loaded: ${data.model_loaded ? 'Yes' : 'No'}\nTimestamp: ${new Date(data.timestamp).toLocaleString('th-TH')}`);
            } catch (error) {
                alert('AI Server Status\n\nStatus: Offline\nError: Cannot connect to server\n\nPlease start the server with:\npython ai/api/app.py');
            }
        }
        
        async function loadRecentChats() {
            const token = getToken();
            if (!token) return;
            
            try {
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'list_chatlogs',
                        token: token,
                        limit: 5
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load recent chats');
                }
                
                const logs = data.data.logs || [];
                const tbody = document.getElementById('recentChats');
                
                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">ยังไม่มีการสนทนา</td></tr>';
                } else {
                    tbody.innerHTML = logs.map(log => {
                        const time = new Date(log.created_at);
                        const timeStr = time.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                        
                        // Convert confidence to percentage
                        const confidence = parseFloat(log.confidence || 0);
                        const confidencePercent = (confidence * 10).toFixed(2); // 9.9999 * 10 = 99.999%
                        const confidenceClass = confidence >= 7 ? 'badge-success' : 
                                               (confidence >= 3.5 ? 'badge-warning' : 'badge-danger');
                        
                        return `
                            <tr>
                                <td>${timeStr}</td>
                                <td>${log.user_message?.substring(0, 40) || '-'}${log.user_message?.length > 40 ? '...' : ''}</td>
                                <td><span class="badge ${confidenceClass}">${confidencePercent}%</span></td>
                                <td>${log.response_time_ms || '-'}ms</td>
                            </tr>
                        `;
                    }).join('');
                }
                
            } catch (error) {
                console.error('Error loading recent chats:', error);
                const tbody = document.getElementById('recentChats');
                tbody.innerHTML = '<tr><td colspan="4" class="loading">ไม่สามารถโหลดข้อมูลได้</td></tr>';
            }
        }
        
        async function loadFAQs() {
            const token = getToken();
            if (!token) return;
            
            try {
                // Get search and filter values
                const searchTerm = document.getElementById('faqSearch')?.value || '';
                const categoryFilter = document.getElementById('categoryFilter')?.value || '';
                const currentPage = window.currentFaqPage || 1;
                const itemsPerPage = 20;
                
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'list_faqs',
                        token: token,
                        search: searchTerm,
                        category: categoryFilter,
                        page: currentPage,
                        limit: itemsPerPage
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    if (response.status === 401) {
                        handleUnauthorized();
                    }
                    throw new Error(data.error || 'Failed to load FAQs');
                }
                
                const faqs = data.data.faqs || [];
                const totalPages = data.data.total_pages || 1;
                const totalItems = data.data.total || 0;
                
                // Render table
                const tbody = document.getElementById('faqList');
                if (faqs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">ไม่พบข้อมูล</td></tr>';
                } else {
                    tbody.innerHTML = faqs.map(faq => `
                        <tr>
                            <td>${faq.id}</td>
                            <td>${faq.question.substring(0, 60)}...</td>
                            <td>${faq.category}</td>
                            <td><span class="badge badge-${faq.is_active ? 'active' : 'inactive'}">${faq.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn-edit" onclick="editFAQ(${faq.id})">แก้ไข</button>
                                    <button class="btn-delete" onclick="deleteFAQ(${faq.id})">ลบ</button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Render pagination
                renderPagination(currentPage, totalPages, totalItems);
                
                // Populate category filter (first time only)
                if (!window.categoriesLoaded && data.data.categories) {
                    const select = document.getElementById('categoryFilter');
                    select.innerHTML = '<option value="">ทุกหมวดหมู่</option>' + 
                        data.data.categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                    window.categoriesLoaded = true;
                }
                
            } catch (error) {
                console.error('Error loading FAQs:', error);
                document.getElementById('faqList').innerHTML = 
                    `<tr><td colspan="5" class="loading">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
            }
        }
        
        function renderPagination(currentPage, totalPages, totalItems) {
            const paginationDiv = document.getElementById('faqPagination');
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = `<span class="page-info">แสดง ${totalItems} รายการ</span>`;
            
            // Previous button
            html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} 
                     onclick="changeFaqPage(${currentPage - 1})">« ก่อนหน้า</button>`;
            
            // Page numbers
            for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                         onclick="changeFaqPage(${i})">${i}</button>`;
            }
            
            if (totalPages > 10) {
                html += `<span class="page-info">... ${totalPages}</span>`;
            }
            
            // Next button
            html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} 
                     onclick="changeFaqPage(${currentPage + 1})">ถัดไป »</button>`;
            
            paginationDiv.innerHTML = html;
        }
        
        function changeFaqPage(page) {
            window.currentFaqPage = page;
            loadFAQs();
        }
        
        // Add event listeners for search and filter
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('faqSearch')?.addEventListener('input', () => {
                window.currentFaqPage = 1;
                loadFAQs();
            });
            
            document.getElementById('categoryFilter')?.addEventListener('change', () => {
                window.currentFaqPage = 1;
                loadFAQs();
            });
        });
        
        // ==================== FAQ CRUD Functions ====================
        
        function openCreateFAQModal() {
            document.getElementById('modalTitle').textContent = 'เพิ่ม FAQ ใหม่';
            document.getElementById('faqForm').reset();
            document.getElementById('faqId').value = '';
            document.getElementById('faqModal').classList.add('show');
        }
        
        async function editFAQ(id) {
            const token = getToken();
            if (!token) return;
            
            try {
                // Fetch FAQ details
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'list_faqs',
                        token: token
                    })
                });
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load FAQ');
                }
                
                const faq = data.data.faqs.find(f => f.id === id);
                if (!faq) {
                    throw new Error('FAQ not found');
                }
                
                // Populate form
                document.getElementById('modalTitle').textContent = 'แก้ไข FAQ';
                document.getElementById('faqId').value = faq.id;
                document.getElementById('faqQuestion').value = faq.question;
                document.getElementById('faqAnswer').value = faq.answer;
                document.getElementById('faqCategory').value = faq.category;
                document.getElementById('faqKeywords').value = faq.keywords || '';
                
                // Open modal
                document.getElementById('faqModal').classList.add('show');
                
            } catch (error) {
                console.error('Error loading FAQ:', error);
                showError('ไม่สามารถโหลดข้อมูล FAQ: ' + error.message);
            }
        }
        
        function closeFAQModal() {
            document.getElementById('faqModal').classList.remove('show');
            document.getElementById('faqForm').reset();
        }
        
        async function saveFAQ(event) {
            event.preventDefault();
            
            const token = getToken();
            if (!token) return;
            
            const id = document.getElementById('faqId').value;
            const question = document.getElementById('faqQuestion').value.trim();
            const answer = document.getElementById('faqAnswer').value.trim();
            const category = document.getElementById('faqCategory').value.trim();
            const keywords = document.getElementById('faqKeywords').value.trim();
            
            if (!question || !answer || !category) {
                showError('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }
            
            try {
                const action = id ? 'update_faq' : 'create_faq';
                const payload = {
                    action: action,
                    token: token,
                    data: {
                        question: question,
                        answer: answer,
                        category: category,
                        keywords: keywords
                    }
                };
                
                if (id) {
                    payload.id = parseInt(id);
                }
                
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    if (response.status === 401) {
                        handleUnauthorized();
                    }
                    throw new Error(data.error || 'Failed to save FAQ');
                }
                
                showSuccess(id ? 'แก้ไข FAQ สำเร็จ' : 'เพิ่ม FAQ สำเร็จ');
                closeFAQModal();
                loadFAQs(); // Reload list
                loadDashboardStats(); // Update stats
                
            } catch (error) {
                console.error('Error saving FAQ:', error);
                showError('บันทึก FAQ ไม่สำเร็จ: ' + error.message);
            }
        }
        
        function editFAQ_old(id) {
            // TODO: Implement edit modal/form
            showError('ฟีเจอร์แก้ไข FAQ กำลังพัฒนา (ID: ' + id + ')');
        }
        
        async function deleteFAQ(id) {
            if (!confirm('ต้องการลบ FAQ นี้? (จะเป็น soft delete)')) {
                return;
            }
            
            const token = getToken();
            if (!token) return;
            
            try {
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'delete_faq',
                        token: token,
                        id: id
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    if (response.status === 401) {
                        handleUnauthorized();
                    }
                    throw new Error(data.error || 'Failed to delete FAQ');
                }
                
                showSuccess('ลบ FAQ สำเร็จ');
                loadFAQs(); // Reload list
                loadDashboardStats(); // Update stats
                
            } catch (error) {
                console.error('Error deleting FAQ:', error);
                showError('ลบ FAQ ไม่สำเร็จ: ' + error.message);
            }
        }
        
        // ==================== Chat Logs Functions ====================
        
        async function exportChatLogsCSV() {
            const token = getToken();
            if (!token) return;
            
            try {
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'list_chatlogs',
                        token: token,
                        limit: 10000 // Export all
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load chat logs');
                }
                
                const logs = data.data.logs || [];
                
                if (logs.length === 0) {
                    alert('ไม่มีข้อมูลที่จะ Export');
                    return;
                }
                
                // Create CSV content
                let csv = '﻿Session ID,วันที่เวลา,คำถาม,คำตอบ,Confidence (%),Response Time (ms)\n';
                
                logs.forEach(log => {
                    const sessionId = (log.session_id || '').replace(/,/g, ';');
                    const created = new Date(log.created_at).toLocaleString('th-TH');
                    const question = (log.user_message || '').replace(/,/g, ';').replace(/\n/g, ' ');
                    const answer = (log.bot_response || '').replace(/,/g, ';').replace(/\n/g, ' ');
                    const confidence = parseFloat(log.confidence || 0);
                    const confidencePercent = (confidence * 10).toFixed(2); // Convert to percentage
                    const responseTime = log.response_time_ms || '0';
                    
                    csv += `"${sessionId}","${created}","${question}","${answer}",${confidencePercent},${responseTime}\n`;
                });
                
                // Download CSV
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `chat_logs_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showSuccess(`Export สำเร็จ! (${logs.length} รายการ)`);
                
            } catch (error) {
                console.error('Error exporting chat logs:', error);
                showError('Export ไม่สำเร็จ: ' + error.message);
            }
        }
        
        async function loadChatLogs() {
            const token = getToken();
            if (!token) return;
            
            try {
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'list_chatlogs',
                        token: token,
                        limit: 50
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    if (response.status === 401) {
                        handleUnauthorized();
                    }
                    throw new Error(data.error || 'Failed to load chat logs');
                }
                
                const logs = data.data.logs || [];
                const tbody = document.getElementById('chatLogsList');
                
                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">ไม่มีข้อมูล</td></tr>';
                } else {
                    tbody.innerHTML = logs.map(log => {
                        // Convert confidence to percentage
                        const confidence = parseFloat(log.confidence || 0);
                        const confidencePercent = (confidence * 10).toFixed(2); // 9.9999 * 10 = 99.99%
                        const confidenceClass = confidence >= 7 ? 'badge-success' : 
                                               (confidence >= 3.5 ? 'badge-warning' : 'badge-danger');
                        
                        return `
                            <tr>
                                <td>${new Date(log.created_at).toLocaleString('th-TH')}</td>
                                <td>${log.user_message?.substring(0, 50) || '-'}...</td>
                                <td>${log.bot_response?.substring(0, 50) || '-'}...</td>
                                <td><span class="badge ${confidenceClass}">${confidencePercent}%</span></td>
                                <td>${log.response_time_ms || '-'}ms</td>
                            </tr>
                        `;
                    }).join('');
                }
                
            } catch (error) {
                console.error('Error loading chat logs:', error);
                document.getElementById('chatLogsList').innerHTML = 
                    `<tr><td colspan="5" class="loading">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
            }
        }
        
        // ==================== Staff Management Functions ====================
        
        async function loadStaff() {
            const token = getToken();
            if (!token) return;
            
            try {
                const searchTerm = document.getElementById('staffSearch')?.value || '';
                const departmentFilter = document.getElementById('departmentFilter')?.value || '';
                const currentPage = window.currentStaffPage || 1;
                const itemsPerPage = 20;
                
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'list_staff',
                        token: token,
                        search: searchTerm,
                        department: departmentFilter,
                        page: currentPage,
                        limit: itemsPerPage
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    if (response.status === 401) {
                        handleUnauthorized();
                    }
                    throw new Error(data.error || 'Failed to load staff');
                }
                
                const staff = data.data.staff || [];
                const totalPages = data.data.total_pages || 1;
                const totalItems = data.data.total || 0;
                
                const tbody = document.getElementById('staffList');
                if (staff.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="loading">ไม่พบข้อมูล</td></tr>';
                } else {
                    tbody.innerHTML = staff.map(s => `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.name_th}</td>
                            <td>${s.department}</td>
                            <td>${s.position || '-'}</td>
                            <td>${s.email || '-'}</td>
                            <td>${s.phone || '-'}</td>
                            <td>
                                <div class="action-btns">
                                    <button class="btn-edit" onclick="editStaff(${s.id})">แก้ไข</button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
                
                // Render pagination
                renderStaffPagination(currentPage, totalPages, totalItems);
                
                // Populate department filter
                if (!window.departmentsLoaded && data.data.departments) {
                    const select = document.getElementById('departmentFilter');
                    select.innerHTML = '<option value="">ทุกภาควิชา</option>' + 
                        data.data.departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
                    window.departmentsLoaded = true;
                }
                
            } catch (error) {
                console.error('Error loading staff:', error);
                document.getElementById('staffList').innerHTML = 
                    `<tr><td colspan="7" class="loading">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
            }
        }
        
        function renderStaffPagination(currentPage, totalPages, totalItems) {
            const paginationDiv = document.getElementById('staffPagination');
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = `<span class="page-info">แสดง ${totalItems} รายการ</span>`;
            html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} 
                     onclick="changeStaffPage(${currentPage - 1})">« ก่อนหน้า</button>`;
            
            for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                         onclick="changeStaffPage(${i})">${i}</button>`;
            }
            
            if (totalPages > 10) {
                html += `<span class="page-info">... ${totalPages}</span>`;
            }
            
            html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} 
                     onclick="changeStaffPage(${currentPage + 1})">ถัดไป »</button>`;
            
            paginationDiv.innerHTML = html;
        }
        
        function changeStaffPage(page) {
            window.currentStaffPage = page;
            loadStaff();
        }
        
        async function editStaff(id) {
            const token = getToken();
            if (!token) return;
            
            try {
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'list_staff',
                        token: token
                    })
                });
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load staff');
                }
                
                const staff = data.data.staff.find(s => s.id === id);
                if (!staff) {
                    throw new Error('Staff not found');
                }
                
                // Populate form
                document.getElementById('staffId').value = staff.id;
                document.getElementById('staffNameTh').value = staff.name_th || '';
                document.getElementById('staffNameEn').value = staff.name_en || '';
                document.getElementById('staffDepartment').value = staff.department || '';
                document.getElementById('staffPosition').value = staff.position || '';
                document.getElementById('staffEmail').value = staff.email || '';
                document.getElementById('staffPhone').value = staff.phone || '';
                document.getElementById('staffRoom').value = staff.room || '';
                document.getElementById('staffOfficeHours').value = staff.office_hours || '';
                document.getElementById('staffAvailability').value = staff.availability || '';
                
                // Open modal
                document.getElementById('staffModal').classList.add('show');
                
            } catch (error) {
                console.error('Error loading staff:', error);
                showError('ไม่สามารถโหลดข้อมูลบุคลากร: ' + error.message);
            }
        }
        
        function closeStaffModal() {
            document.getElementById('staffModal').classList.remove('show');
            document.getElementById('staffForm').reset();
        }
        
        async function saveStaff(event) {
            event.preventDefault();
            
            const token = getToken();
            if (!token) return;
            
            const id = document.getElementById('staffId').value;
            
            if (!id) {
                showError('ไม่พบ ID บุคลากร');
                return;
            }
            
            try {
                const payload = {
                    action: 'update_staff',
                    token: token,
                    id: parseInt(id),
                    data: {
                        name_th: document.getElementById('staffNameTh').value.trim(),
                        name_en: document.getElementById('staffNameEn').value.trim(),
                        department: document.getElementById('staffDepartment').value.trim(),
                        position: document.getElementById('staffPosition').value.trim(),
                        email: document.getElementById('staffEmail').value.trim(),
                        phone: document.getElementById('staffPhone').value.trim(),
                        room: document.getElementById('staffRoom').value.trim(),
                        office_hours: document.getElementById('staffOfficeHours').value.trim(),
                        availability: document.getElementById('staffAvailability').value.trim()
                    }
                };
                
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    if (response.status === 401) {
                        handleUnauthorized();
                    }
                    throw new Error(data.error || 'Failed to update staff');
                }
                
                showSuccess('แก้ไขข้อมูลบุคลากรสำเร็จ');
                closeStaffModal();
                loadStaff();
                
            } catch (error) {
                console.error('Error saving staff:', error);
                showError('บันทึกข้อมูลไม่สำเร็จ: ' + error.message);
            }
        }
        
        // Add event listeners for staff search/filter
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('staffSearch')?.addEventListener('input', () => {
                window.currentStaffPage = 1;
                loadStaff();
            });
            
            document.getElementById('departmentFilter')?.addEventListener('change', () => {
                window.currentStaffPage = 1;
                loadStaff();
            });
        });
        
        // ==================== News Management Functions ====================
        
        async function loadNews() {
            const token = getToken();
            if (!token) return;
            
            try {
                const searchTerm = document.getElementById('newsSearch')?.value || '';
                const categoryFilter = document.getElementById('newsCategoryFilter')?.value || '';
                const currentPage = window.currentNewsPage || 1;
                const itemsPerPage = 20;
                
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'list_news',
                        token: token,
                        search: searchTerm,
                        category: categoryFilter,
                        page: currentPage,
                        limit: itemsPerPage
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    if (response.status === 401) {
                        handleUnauthorized();
                    }
                    throw new Error(data.error || 'Failed to load news');
                }
                
                const news = data.data.news || [];
                const totalPages = data.data.total_pages || 1;
                const totalItems = data.data.total || 0;
                
                const tbody = document.getElementById('newsList');
                if (news.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="loading">ไม่พบข้อมูล</td></tr>';
                } else {
                    tbody.innerHTML = news.map(item => {
                        const publishedDate = item.published_date ? 
                            new Date(item.published_date).toLocaleDateString('th-TH') : '-';
                        const statusClass = item.is_active == 1 ? 'badge-active' : 'badge-inactive';
                        const statusText = item.is_active == 1 ? 'เผยแพร่' : 'ไม่เผยแพร่';
                        
                        return `
                            <tr>
                                <td>${item.id}</td>
                                <td style="max-width: 300px;">${item.title || '-'}</td>
                                <td><span class="badge badge-info">${item.category || '-'}</span></td>
                                <td>${publishedDate}</td>
                                <td>${item.view_count || 0}</td>
                                <td><span class="badge ${statusClass}">${statusText}</span></td>
                                <td>
                                    <div class="action-btns">
                                        <button class="btn-edit" onclick="editNews(${item.id})">แก้ไข</button>
                                        <button class="btn-delete" onclick="deleteNews(${item.id})">ลบ</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                renderNewsPagination(currentPage, totalPages, totalItems);
                
            } catch (error) {
                console.error('Error loading news:', error);
                document.getElementById('newsList').innerHTML = 
                    `<tr><td colspan="7" class="loading">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
            }
        }
        
        function renderNewsPagination(currentPage, totalPages, totalItems) {
            const paginationDiv = document.getElementById('newsPagination');
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = `<span class="page-info">แสดง ${totalItems} รายการ</span>`;
            html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} 
                     onclick="changeNewsPage(${currentPage - 1})">« ก่อนหน้า</button>`;
            
            for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                         onclick="changeNewsPage(${i})">${i}</button>`;
            }
            
            if (totalPages > 10) {
                html += `<span class="page-info">... ${totalPages}</span>`;
            }
            
            html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} 
                     onclick="changeNewsPage(${currentPage + 1})">ถัดไป »</button>`;
            
            paginationDiv.innerHTML = html;
        }
        
        function changeNewsPage(page) {
            window.currentNewsPage = page;
            loadNews();
        }
        
        function openCreateNewsModal() {
            document.getElementById('newsModalTitle').textContent = 'เพิ่มข่าวใหม่';
            document.getElementById('newsId').value = '';
            document.getElementById('newsForm').reset();
            document.getElementById('newsPublishedDate').valueAsDate = new Date();
            document.getElementById('newsModal').classList.add('show');
        }
        
        async function editNews(id) {
            const token = getToken();
            if (!token) return;
            
            try {
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'list_news',
                        token: token
                    })
                });
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load news');
                }
                
                const newsItem = data.data.news.find(n => n.id == id);
                if (!newsItem) {
                    throw new Error('News not found');
                }
                
                // Populate form
                document.getElementById('newsModalTitle').textContent = 'แก้ไขข่าว';
                document.getElementById('newsId').value = newsItem.id;
                document.getElementById('newsTitle').value = newsItem.title || '';
                document.getElementById('newsContent').value = newsItem.content || '';
                document.getElementById('newsSummary').value = newsItem.summary || '';
                document.getElementById('newsCategory').value = newsItem.category || '';
                document.getElementById('newsPublishedDate').value = newsItem.published_date || '';
                document.getElementById('newsLinkUrl').value = newsItem.link_url || '';
                document.getElementById('newsThumbnailUrl').value = newsItem.thumbnail_url || '';
                document.getElementById('newsTags').value = newsItem.tags || '';
                
                document.getElementById('newsModal').classList.add('show');
                
            } catch (error) {
                console.error('Error loading news:', error);
                showError('โหลดข้อมูลข่าวไม่สำเร็จ: ' + error.message);
            }
        }
        
        function closeNewsModal() {
            document.getElementById('newsModal').classList.remove('show');
        }
        
        async function saveNews(event) {
            event.preventDefault();
            
            const token = getToken();
            if (!token) return;
            
            const id = document.getElementById('newsId').value;
            const title = document.getElementById('newsTitle').value.trim();
            const content = document.getElementById('newsContent').value.trim();
            
            if (!title || !content) {
                showError('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }
            
            try {
                const action = id ? 'update_news' : 'create_news';
                const payload = {
                    action: action,
                    token: token,
                    data: {
                        title: title,
                        content: content,
                        summary: document.getElementById('newsSummary').value.trim(),
                        category: document.getElementById('newsCategory').value,
                        published_date: document.getElementById('newsPublishedDate').value,
                        link_url: document.getElementById('newsLinkUrl').value.trim(),
                        thumbnail_url: document.getElementById('newsThumbnailUrl').value.trim(),
                        tags: document.getElementById('newsTags').value.trim(),
                        is_active: 1
                    }
                };
                
                if (id) {
                    payload.id = parseInt(id);
                }
                
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    if (response.status === 401) {
                        handleUnauthorized();
                    }
                    throw new Error(data.error || 'Failed to save news');
                }
                
                showSuccess(id ? 'แก้ไขข่าวสำเร็จ' : 'เพิ่มข่าวสำเร็จ');
                closeNewsModal();
                loadNews();
                
            } catch (error) {
                console.error('Error saving news:', error);
                showError('บันทึกข้อมูลไม่สำเร็จ: ' + error.message);
            }
        }
        
        async function deleteNews(id) {
            if (!confirm('คุณต้องการลบข่าวนี้หรือไม่?')) {
                return;
            }
            
            const token = getToken();
            if (!token) return;
            
            try {
                const response = await fetch('../backend/admin_api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'delete_news',
                        token: token,
                        id: id
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    if (response.status === 401) {
                        handleUnauthorized();
                    }
                    throw new Error(data.error || 'Failed to delete news');
                }
                
                showSuccess('ลบข่าวสำเร็จ');
                loadNews();
                
            } catch (error) {
                console.error('Error deleting news:', error);
                showError('ลบข่าวไม่สำเร็จ: ' + error.message);
            }
        }
        
        async function scrapeNews() {
            if (!confirm('ต้องการดึงข่าวใหม่จากเว็บไซต์หรือไม่?\n(อาจใช้เวลาสักครู่)')) {
                return;
            }
            
            showSuccess('กำลังดึงข่าว... (อาจใช้เวลา 10-30 วินาที)');
            
            try {
                const response = await fetch('../scripts/scrape_news.php', {
                    method: 'GET'
                });
                
                const text = await response.text();
                
                // Reload news after scraping
                setTimeout(() => {
                    loadNews();
                    showSuccess('ดึงข่าวเสร็จสิ้น! กรุณารีเฟรชหน้าเพื่อดูข่าวใหม่');
                }, 2000);
                
            } catch (error) {
                console.error('Error scraping news:', error);
                showError('ดึงข่าวไม่สำเร็จ: ' + error.message);
            }
        }
        
        // Add event listeners for news search/filter
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('newsSearch')?.addEventListener('input', () => {
                window.currentNewsPage = 1;
                loadNews();
            });
            
            document.getElementById('newsCategoryFilter')?.addEventListener('change', () => {
                window.currentNewsPage = 1;
                loadNews();
            });
        });
        
        // ==================== Logout ====================
        
        function logout() {
            if (confirm('ต้องการออกจากระบบ?')) {
                const token = getToken();
                
                // Call logout API (optional - for tracking)
                if (token) {
                    fetch('../backend/admin_login.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'logout',
                            token: token
                        })
                    }).catch(err => console.error('Logout API error:', err));
                }
                
                localStorage.removeItem('admin_token');
                window.location.href = 'login.html';
            }
        }
        
        // ==================== Initialize ====================
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const faqModal = document.getElementById('faqModal');
            const staffModal = document.getElementById('staffModal');
            
            if (event.target === faqModal) {
                closeFAQModal();
            } else if (event.target === staffModal) {
                closeStaffModal();
            }
        };
        
        // Load initial data
        loadDashboardStats();
    </script>
</body>
</html>
